<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClearViz, Data Reimagined</title>
    <link rel="icon" type="image/png" href="./assets/icon.png">
    <link rel="apple-touch-icon" href="./assets/icon.png">
    <link rel="shortcut icon" href="./assets/icon.png">
    <meta name="theme-color" content="#0a0b0d">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
    --bg-primary: #0a0b0d; 
    --bg-secondary: #111317; 
    --bg-tertiary: #21262d;
    --bg-accent: #1c2128;
    --text-primary: #f6f8fa;
    --text-secondary: #9ca3af;
    --text-muted: #6b7280;
    --border-primary: #374151;
    --border-secondary: #2d3748;
    --accent-blue: #6366f1;
    --accent-purple: #bc8cff;
    --accent-green: #3fb950;
    --accent-orange: #f85149;
    --accent-yellow: #d29922;
    --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --gradient-secondary: linear-gradient(135deg, #3fb950 0%, #6366f1 100%);
    --gradient-brand: linear-gradient(135deg, #58a6ff 0%, #bc8cff 100%);
    --shadow-primary: 0 16px 32px rgba(1, 4, 9, 0.85);
    --shadow-secondary: 0 8px 24px rgba(1, 4, 9, 0.5);
    --shadow-subtle: 0 4px 12px rgba(1, 4, 9, 0.3);
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.65;
    overflow-x: hidden;
    font-weight: 400;
    letter-spacing: -0.01em;
}

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo-icon {
            width: 32px; /* Adjust size as needed */
            height: 32px;
            /* background removed */
            /* border-radius removed */
            /* display: flex removed */
            align-items: center;
            justify-content: center;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(33, 38, 45, 0.9) 100%);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    min-height: 40px;
    position: relative;
    box-shadow: 0 4px 12px rgba(1, 4, 9, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(1, 4, 9, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    background: linear-gradient(135deg, var(--bg-accent) 0%, rgba(28, 33, 40, 0.95) 100%);
}

.btn:focus {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
}


        .btn-primary {
            background: var(--gradient-brand);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: var(--gradient-brand);
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-back {
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            padding: 0.75rem;
            margin-right: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
        }

        .btn-back:hover {
            background: var(--bg-accent);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            transform: translateX(-2px);
        }

        .btn-back i {
            font-size: 1rem;
        }

.main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 2rem;
    align-items: start;
    position: relative;
}

        .sidebar {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 16px;
    height: 100%;
    max-height: none;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px rgba(1, 4, 9, 0.4);
    overflow: hidden;
}

        .sidebar-section {
    padding: 2rem;
    border-bottom: 1px solid var(--border-secondary);
    flex-shrink: 0;
    background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(17, 19, 23, 0.8) 100%);
}

.sidebar-section:first-child {
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
}

.sidebar-section:last-child {
    border-bottom: none;
    border-bottom-left-radius: 16px;
    border-bottom-right-radius: 16px;
}

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .upload-area {
    border: 2px dashed rgba(88, 166, 255, 0.4);
    border-radius: 16px;
    padding: 3rem 2rem;
    text-align: center;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    background: 
        linear-gradient(135deg, rgba(88, 166, 255, 0.03) 0%, rgba(33, 38, 45, 0.8) 100%),
        radial-gradient(circle at center, rgba(88, 166, 255, 0.1) 0%, transparent 70%);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(8px);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.upload-area::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent 30%, rgba(88, 166, 255, 0.05) 50%, transparent 70%);
    animation: shimmer 3s ease-in-out infinite;
    pointer-events: none;
}

@keyframes shimmer {
    0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.upload-area:hover {
    border-color: var(--accent-blue);
    background: 
        linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(33, 38, 45, 0.9) 100%),
        radial-gradient(circle at center, rgba(88, 166, 255, 0.2) 0%, transparent 70%);
    transform: translateY(-4px);
    box-shadow: 
        0 12px 32px rgba(1, 4, 9, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.upload-area.dragover {
    border-color: var(--accent-green);
    background: 
        linear-gradient(135deg, rgba(63, 185, 80, 0.15) 0%, rgba(33, 38, 45, 0.9) 100%),
        radial-gradient(circle at center, rgba(63, 185, 80, 0.2) 0%, transparent 70%);
    transform: scale(1.02);
}


        .upload-area.dragover {
            border-color: var(--accent-blue);
            background: rgba(88, 166, 255, 0.1);
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .upload-text {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-select, .form-input {
    width: 100%;
    padding: 1rem;
    background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(33, 38, 45, 0.9) 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 48px;
    box-shadow: 
        0 2px 8px rgba(1, 4, 9, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(8px);
}

.form-select:focus, .form-input:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.05) 0%, rgba(33, 38, 45, 0.95) 100%);
    box-shadow: 
        0 0 0 3px rgba(88, 166, 255, 0.2),
        0 4px 16px rgba(1, 4, 9, 0.3),
        0 0 12px rgba(88, 166, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    transform: translateY(-1px);
}

        .form-select option {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .axis-selectors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .axis-selector-group {
            display: flex;
            flex-direction: column;
        }

        .claude-dropdown {
            position: relative;
            width: 100%;
        }

        .claude-dropdown-button {
    background: #111317;
    border: 1.5px solid #30363d;
    border-radius: 10px;
    padding: 0.85rem 1rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 50px;
    position: relative;
}

.claude-dropdown-button:focus {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
}

.claude-dropdown-button:hover {
    background: #1c2128;
    border-color: #58a6ff;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(1, 4, 9, 0.15);
}

        .claude-dropdown-button:hover {
            background: #1c2128;
            border-color: #58a6ff;
        }

        .claude-dropdown-content {
            flex: 1;
            text-align: left;
        }

        .claude-dropdown-title {
            color: #f0f6fc;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .claude-dropdown-arrow {
            color: #8b949e;
            font-size: 0.75rem;
            transition: transform 0.2s ease;
        }

        .claude-dropdown.open .claude-dropdown-arrow {
            transform: rotate(180deg);
        }

        .claude-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #111317;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(1, 4, 9, 0.5);
        }

        .claude-dropdown-menu.show {
            display: block;
        }

        .claude-dropdown-option {
            padding: 0.75rem;
            color: #f0f6fc;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #21262d;
            font-size: 0.875rem;
        }

        .claude-dropdown-option:last-child {
            border-bottom: none;
        }

        .claude-dropdown-option:hover {
            background: #1c2128;
        }

        .claude-dropdown-option.selected {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
        }
        #insightsContainer {
    max-height: 300px;
    overflow-x: auto;
    overflow-y: auto;
    padding: 0.5rem 0.5rem 0.5rem 0;
}

        .insights-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    min-width: 300px;
    padding: 0.25rem;
}

        .claude-dropdown-option.selected::after {
            content: "✓";
            float: right;
            color: #58a6ff;
        }

        .chart-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .chart-type-btn {
    padding: 1rem;
    background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(33, 38, 45, 0.8) 100%);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    position: relative;
    overflow: hidden;
}

.chart-type-btn i {
    font-size: 1rem;
    transition: all 0.3s ease;
}

.chart-type-btn:hover {
    transform: translateY(-4px) scale(1.02);
    border-color: rgba(88, 166, 255, 0.5);
    color: var(--accent-blue);
    box-shadow: 
        0 12px 32px rgba(1, 4, 9, 0.4),
        0 0 20px rgba(88, 166, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(33, 38, 45, 0.9) 100%);
}

.chart-type-btn:hover i {
    color: var(--accent-blue);
    transform: scale(1.1);
}

.chart-type-btn.active {
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.2) 0%, rgba(99, 102, 241, 0.15) 100%);
    border-color: var(--accent-blue);
    color: var(--accent-blue);
    box-shadow: 
        0 8px 24px rgba(1, 4, 9, 0.4),
        0 0 16px rgba(88, 166, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.chart-type-btn.active i {
    color: var(--accent-blue);
}

        .main-content {
    display: flex;
    flex-direction: column;
    height: fit-content;
    min-height: calc(100vh - 120px);
    gap: 2rem;
    position: relative;
    margin-top: 0;
    transition: margin-top 0.3s ease;
}

        .main-content .content-card:first-child {
            flex: 1; 
            height: 400px;
        }

        .main-content .content-card:last-child {
            
            margin-top: auto; 
        }

.content-card {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(17, 19, 23, 0.95) 100%);
    border: 1px solid rgba(88, 166, 255, 0.2);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 
        0 8px 32px rgba(1, 4, 9, 0.6),
        0 1px 0 rgba(255, 255, 255, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    height: 100%;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(12px);
    position: relative;
}

.content-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.5), transparent);
}

        .content-card.full-height {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .content-card.full-height .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-card.full-height .chart-container {
            flex: 1;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        .chart-container {
    background: linear-gradient(135deg, var(--bg-primary) 0%, rgba(10, 11, 13, 0.95) 100%);
    border-radius: 12px;
    padding: 2.5rem;
    min-height: 600px;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    border: 1px solid rgba(48, 54, 61, 0.3);
}
        .chart-container canvas {
            max-height: 100% !important;
            max-width: 100% !important;
            height: 100% !important;
            width: 100% !important;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .preview-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-secondary);
            color: var(--text-primary);
        }

        .preview-table tr:hover {
            background: var(--bg-tertiary);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .insight-card {
    background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(33, 38, 45, 0.8) 100%);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.insight-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(99, 102, 241, 0.08) 50%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.insight-card:hover::before {
    opacity: 1;
}

        .insight-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent-blue);
}

        .insight-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 0.25rem;
        }

        .insight-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-success {
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid rgba(63, 185, 80, 0.3);
            color: var(--accent-green);
        }

        .status-error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            color: var(--accent-orange);
        }

        .hidden {
            display: none !important;
        }

        .file-input {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 300px;
        }


        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state-text {
            font-size: 0.875rem;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .sidebar {
                position: static;
            }
            
            .header-content {
                padding: 0 1rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .logo {
                font-size: 1.25rem;
            }
            
            .header-actions {
                gap: 0.5rem;
            }
            
            .btn {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            
            .chart-types {
                grid-template-columns: 1fr;
            }
        }

        .flourish-glow {
            background: var(--gradient-primary);
            background-size: 200% 200%;
            animation: flourishGlow 3s ease-in-out infinite;
        }

        @keyframes flourishGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .chart-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-primary);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Hero Animation Styles */
.hero-content {
    position: relative;
    z-index: 10;
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
    padding: 8rem 2rem 4rem;
    opacity: 0;
    transform: translateY(50px);
    animation: fadeInUp 1s ease-out forwards;
}

.nav-bar {
    position: relative;
    z-index: 10;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-primary);
    opacity: 0;
    transform: translateY(-30px);
    animation: fadeInDown 0.8s ease-out forwards;
}

@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeInDown {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.hero-badge {
    animation-delay: 0.2s;
    opacity: 0;
    transform: translateY(30px);
    animation: fadeInUp 0.8s ease-out forwards;
}

.hero-title {
    animation-delay: 0.4s;
    opacity: 1;
    transform: translateY(0);
    animation: fadeInUp 0.8s ease-out forwards;
}

.hero-subtitle {
    font-size: 1.25rem;
    color: var(--text-secondary);
    margin-bottom: 3rem;
    line-height: 1.6;
}

.animated-subtitle {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 1.2s ease, transform 1.2s ease;
}

.animated-subtitle.show {
    opacity: 1;
    transform: translateY(0);
}

.upload-hero-area {
    animation-delay: 0.8s;
    opacity: 0;
    transform: translateY(30px);
    animation: fadeInUp 0.8s ease-out forwards;
}

/* Reset animations when showing data page */
.hero-section.hide-animations * {
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
}
        /* Hero Section Styles */
.hero-section {
    min-height: 100vh;
    background: var(--bg-primary);
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 50%, rgba(88, 166, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(188, 140, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(63, 185, 80, 0.1) 0%, transparent 50%);
    pointer-events: none;
}
#heroUploadArea {
    position: relative;
}        

.nav-bar {
    position: relative;
    z-index: 10;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-primary);
}

.nav-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.logo-text {
    background: var(--gradient-brand);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.nav-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
}

.btn-outline:hover {
    border-color: var(--accent-blue);
    color: var(--accent-blue);
}

.hero-content {
    position: relative;
    z-index: 10;
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
    padding: 8rem 2rem 4rem;
}

.hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: rgba(88, 166, 255, 0.1);
    border: 1px solid rgba(88, 166, 255, 0.3);
    border-radius: 20px;
    color: var(--accent-blue);
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 2rem;
    animation-delay: 0.2s;
    opacity: 0;
    transform: translateY(30px);
    animation: fadeInUp 0.8s ease-out forwards;
}

.hero-title {
    font-size: 3.5rem;
    font-weight: 700;
    line-height: 1.1;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    white-space: nowrap;
    animation-delay: 0.4s;
    opacity: 0;
    transform: translateY(30px);
    animation: fadeInUp 0.8s ease-out forwards;
}

.hero-highlight {
    background: var(--gradient-brand);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero-subtitle {
    font-size: 1.25rem;
    color: var(--text-secondary);
    margin-bottom: 3rem;
    line-height: 1.6;
    animation-delay: 0.6s;
    opacity: 0;
    transform: translateY(30px);
    animation: fadeInUp 0.8s ease-out forwards;
}

.upload-hero-area {
    background: var(--bg-secondary);
    border: 2px dashed var(--border-primary);
    border-radius: 12px;
    padding: 2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    max-width: 500px;
    margin: 0 auto;
    animation-delay: 0.8s;
    opacity: 0;
    transform: translateY(30px);
    animation: fadeInUp 0.8s ease-out forwards;
}

.upload-hero-area:hover {
    border-color: var(--accent-blue);
    background: rgba(88, 166, 255, 0.05);
}

.upload-hero-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.upload-hero-icon {
    font-size: 2rem;
    color: var(--accent-blue);
    margin-bottom: 0.5rem;
}

.upload-hero-formats {
    font-size: 0.875rem;
    color: var(--text-muted);
}

#toggleRegression {
    appearance: none;
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
}

#toggleRegression:hover {
    border-color: var(--accent-blue);
    background: var(--bg-accent);
}

#toggleRegression:checked {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
}

#toggleRegression:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

#regressionToggleWrapper {
    color: var(--text-secondary);
    font-weight: 500;
}
.file-list {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.file-tile {
    background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(33, 38, 45, 0.8) 100%);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    position: relative;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.file-tile::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(255, 182, 193, 0.1) 0%, 
        rgba(186, 85, 211, 0.1) 25%, 
        rgba(138, 43, 226, 0.1) 50%, 
        rgba(75, 0, 130, 0.1) 75%, 
        rgba(255, 182, 193, 0.1) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.file-tile:hover::before {
    opacity: 1;
}

.file-tile:hover {
    transform: translateY(-2px);
    border-color: rgba(188, 140, 255, 0.5);
    box-shadow: 0 8px 24px rgba(1, 4, 9, 0.4);
}

.file-tile:hover {
    background: var(--bg-accent);
    border-color: var(--accent-blue);
}

.file-tile.active {
    background: rgba(88, 166, 255, 0.1);
    border-color: var(--accent-blue);
    color: var(--accent-blue);
}

.file-tile-name {
    color: var(--text-primary);
    font-weight: 500;
}

.file-tile.active .file-tile-name {
    color: var(--accent-blue);
}

.file-delete-btn {
    background: transparent;
    border: none;
    color: var(--accent-orange);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
}

.file-delete-btn:hover {
    background: rgba(248, 81, 73, 0.1);
    color: #ff6b6b;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    box-shadow: var(--shadow-primary);
}

.modal-title {
    color: var(--text-primary);
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.modal-text {
    color: var(--text-secondary);
    margin-bottom: 2rem;
    line-height: 1.5;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.btn-cancel {
    background: transparent;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
}

.btn-delete {
    background: var(--accent-orange);
    border: none;
    color: white;
}

.btn-delete:hover {
    background: #ff6b6b;
}
#statusMessage {
    position: relative;
    z-index: 10;
    margin: 0 0 1.5rem 0;
    padding: 0;
}
.status-message {
    margin-bottom: 1.5rem;
}   
.section-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 1.2rem;
}

.card-title {
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    letter-spacing: -0.02em;
}

.upload-text {
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.upload-subtext {
    color: var(--text-muted);
    font-size: 0.82rem;
    font-weight: 500;
}
.chart-type-btn:focus,
.file-tile:focus,
.btn-back:focus {
    outline: 2px solid var(--accent-blue);
    outline-offset: 2px;
}

.upload-area:focus {
    outline: 2px solid var(--accent-blue);
    outline-offset: 4px;
}


*:focus {
    transition: outline 0.15s ease;
}

.regression-equation {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: rgba(17, 19, 23, 0.9);
    border: 1px solid rgba(88, 166, 255, 0.3);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    color: var(--text-primary);
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    font-weight: 500;
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 12px rgba(1, 4, 9, 0.3);
    z-index: 10;
}
.typing-text {
    display: inline-block;
}

.typing-cursor {
    display: inline-block;
    animation: blink 1s infinite;
    color: var(--accent-blue);
    font-weight: 700;
    font-size: 0.8em;
    line-height: 1;
}

.data-reimagined {
    display: inline-block;
}

.animated-subtitle {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 1.2s ease, transform 1.2s ease;
}

.animated-subtitle.show {
    opacity: 1;
    transform: translateY(0);
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

/* AI Chatbox Styles */
.ai-chatbox-hero {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(17, 19, 23, 0.95) 100%);
    border: 2px solid rgba(88, 166, 255, 0.3);
    border-radius: 20px;
    padding: 2rem;
    max-width: 600px;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
    animation-delay: 0.8s;
    opacity: 0;
    transform: translateY(30px);
    animation: fadeInUp 0.8s ease-out forwards;
}

.ai-chatbox-hero {
    position: relative;
    overflow: hidden;
}
.ai-chatbox-hero.dragover {
    border-color: var(--accent-blue) !important;
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.15) 0%, rgba(17, 19, 23, 0.95) 100%) !important;
    transform: scale(1.02);
}

.ai-chatbox-hero.dragover::after {
    content: "Drop your file here. 📁";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(88, 166, 255, 0.9);
    color: white;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    z-index: 10;
}

.ai-chatbox-hero::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 20px;
    padding: 1px;
    background: linear-gradient(90deg, transparent, transparent, #58a6ff, transparent, transparent);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask-composite: xor;
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    animation: borderTravel 4s linear infinite;
}

@keyframes borderTravel {
    0% {
        background: linear-gradient(90deg, #58a6ff, transparent, transparent, transparent, transparent);
        background-size: 200% 200%;
        background-position: 0% 50%;
    }
    25% {
        background: linear-gradient(180deg, #58a6ff, transparent, transparent, transparent, transparent);
        background-size: 200% 200%;
        background-position: 50% 0%;
    }
    50% {
        background: linear-gradient(270deg, #58a6ff, transparent, transparent, transparent, transparent);
        background-size: 200% 200%;
        background-position: 100% 50%;
    }
    75% {
        background: linear-gradient(0deg, #58a6ff, transparent, transparent, transparent, transparent);
        background-size: 200% 200%;
        background-position: 50% 100%;
    }
    100% {
        background: linear-gradient(90deg, #58a6ff, transparent, transparent, transparent, transparent);
        background-size: 200% 200%;
        background-position: 0% 50%;
    }
}
.ai-chatbox-hero.dragover {
    border-color: var(--accent-blue);
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.15) 0%, rgba(17, 19, 23, 0.95) 100%);
    transform: scale(1.02);
}

.ai-chatbox-hero.dragover::after {
    content: "Drop your file here. 📁";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(88, 166, 255, 0.9);
    color: white;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    z-index: 10;
}
.ai-chatbox-hero.dragover {
    border-color: var(--accent-blue);
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.15) 0%, rgba(17, 19, 23, 0.95) 100%);
    transform: scale(1.02);
}

.ai-chatbox-hero.dragover::after {
    content: "Drop your file here. 📁";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(88, 166, 255, 0.9);
    color: white;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    z-index: 10;
}

.chatbox-header {
    text-align: center;
    margin-bottom: 1.5rem;
}

.chatbox-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.chatbox-subtitle {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.chatbox-input-container {
    position: relative;
}

.chatbox-input-wrapper {
    display: flex;
    align-items: center;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 0.75rem;
    gap: 0.75rem;
    transition: all 0.3s ease;
}

.chatbox-input-wrapper:focus-within {
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
}

.file-upload-btn {
    background: var(--bg-accent);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
}

.file-upload-btn:hover {
    background: var(--accent-blue);
    color: white;
}

.chatbox-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 0.875rem;
    outline: none;
}

.chatbox-input::placeholder {
    color: var(--text-muted);
}

.model-selector-btn {
    background: var(--bg-accent);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    min-width: 120px;
    height: 36px;
    position: relative;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.model-selector-btn:hover {
    background: var(--accent-purple);
    color: white;
}

.send-btn {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
    color: var(--text-secondary);
}

.send-btn:hover {
    background: var(--bg-accent);
    color: var(--text-primary);
    border-color: var(--accent-blue);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.model-dropdown {
    position: absolute;
    bottom: 100%;
    right: 0;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 0.5rem;
    display: none;
    z-index: 1000;
    min-width: 200px;
    margin-bottom: 0.5rem;
    box-shadow: var(--shadow-primary);
    max-height: 250px;
    overflow-y: auto;
}

.model-dropdown.show {
    display: block;
}

.model-option {
    padding: 0.75rem;
    color: var(--text-primary);
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.model-option:hover:not(.disabled) {
    background: var(--bg-accent);
}

.model-option.selected {
    background: rgba(88, 166, 255, 0.1);
    color: var(--accent-blue);
}

.model-option.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.model-option i {
    opacity: 0;
}

.model-option.selected i {
    opacity: 1;
}

.file-preview {
    margin-top: 1rem;
    background: var(--bg-accent);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 0.75rem;
}

.file-preview-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.file-name {
    color: var(--text-primary);
    font-size: 0.875rem;
}

.file-remove-btn {
    background: transparent;
    border: none;
    color: var(--accent-orange);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.file-remove-btn:hover {
    background: rgba(248, 81, 73, 0.1);
}
.floating-chatbox {
    position: sticky;
    bottom: 0;
    background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(17, 19, 23, 0.95) 100%);
    border: 2px solid rgba(88, 166, 255, 0.3);
    border-radius: 20px;
    padding: 1.5rem;
    margin: 2rem 0;
    backdrop-filter: blur(12px);
    box-shadow: var(--shadow-primary);
    transition: all 0.3s ease;
}

.floating-chatbox.scrolled {
    transform: translateX(-50%) scale(0.9);
    bottom: 1rem;
}

.floating-chatbox-header {
    text-align: center;
    margin-bottom: 1rem;
}

.floating-chatbox-input {
    position: relative;
}
.chat-log {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 16px;
    padding: 1.5rem;
    margin: 2rem 0;
    max-height: 600px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.chat-message {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.ai-message {
    align-items: flex-start;
}

.user-message {
    align-items: flex-end;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.ai-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.message-content {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1rem;
    max-width: 70%;
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.user-message .message-content {
    background: rgba(88, 166, 255, 0.1);
    border-color: rgba(88, 166, 255, 0.3);
}

.message-text {
    flex: 1;
    color: var(--text-primary);
    line-height: 1.5;
}

.copy-btn {
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    opacity: 0;
    flex-shrink: 0;
}

.message-content:hover .copy-btn {
    opacity: 1;
}

.copy-btn:hover {
    background: var(--bg-accent);
    color: var(--accent-blue);
}

/* Modern Header and Sidebar */
.history-sidebar {
    position: fixed;
    top: 0;
    left: -320px;
    width: 320px;
    height: 100vh;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-primary);
    z-index: 1001;
    transition: left 0.3s ease;
    overflow-y: auto;
    padding: 1rem;
}

.history-sidebar.open {
    left: 0;
}

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: none;
    pointer-events: none;
}

.sidebar-overlay.show {
    display: block;
    pointer-events: auto;
}

.sidebar-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-primary);
}

.new-chat-btn, .home-btn {
    width: 100%;
    justify-content: center;
}

.chat-history-section {
    flex: 1;
}

.chat-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.chat-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.chat-item:hover {
    background: var(--bg-accent);
    border-color: var(--accent-blue);
}

.chat-item.active {
    background: rgba(88, 166, 255, 0.1);
    border-color: var(--accent-blue);
    color: var(--accent-blue);
}

.chat-item-title {
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.875rem;
    cursor: text;
}

.chat-item.active .chat-item-title {
    color: var(--accent-blue);
}


.sidebar-toggle-btn {
    background: transparent;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    padding: 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
}

.sidebar-toggle-btn:hover {
    background: var(--bg-accent);
    border-color: var(--accent-blue);
    color: var(--accent-blue);
}

.modern-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-primary);
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
    transition: margin-left 0.3s ease;
}

.modern-header.sidebar-open {
    margin-left: 320px;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-center {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
}

.chat-title-container {
    max-width: 400px;
}

.chat-title-text {
    color: var(--text-primary);
    font-size: 1.125rem;
    font-weight: 600;
    text-align: center;
    outline: none;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    transition: all 0.2s ease;
    display: inline-block;
    min-width: 200px;
    white-space: nowrap;
    overflow: hidden;
}

.chat-title-text:focus {
    background: var(--bg-tertiary);
    border: 1px solid var(--accent-blue);
    white-space: nowrap;
}

.chat-title-text:hover {
    background: rgba(255, 255, 255, 0.05);
}

.chat-title-text:focus {
    background: var(--bg-tertiary);
    border: 1px solid var(--accent-blue);
}

.nav-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-right-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.chart-popup-btn {
    min-width: 40px;
    height: 40px;
    padding: 0.5rem;
}

.export-chat-btn {
    min-width: 40px;
    height: 40px;
    padding: 0.5rem;
}

body.sidebar-open .main-container,
body.sidebar-open .hero-section {
    margin-left: 320px;
    transition: margin-left 0.3s ease;
}

.typing-title {
    overflow: hidden;
    border-right: 2px solid var(--accent-blue);
    white-space: nowrap;
    animation: typing 2s steps(20, end), blink-caret 0.75s step-end infinite;
}

@keyframes typing {
    from { width: 0; }
    to { width: 100%; }
}

@keyframes blink-caret {
    from, to { border-color: transparent; }
    50% { border-color: var(--accent-blue); }
}

/* Help Page */
.help-page {
    min-height: 100vh;
    background: var(--bg-primary);
    transition: margin-left 0.3s ease;
}

.help-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-primary);
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
}

.help-header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
}

.help-page-title {
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.help-content {
    max-width: 1000px;
    margin: 0 auto;
    padding: 4rem 2rem;
}

.help-section {
    margin-bottom: 4rem;
}

.help-section h2 {
    color: var(--text-primary);
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-align: center;
}

.help-section h3 {
    color: var(--text-primary);
    font-size: 1.75rem;
    font-weight: 600;
    margin-bottom: 2rem;
}

.help-section p {
    color: var(--text-secondary);
    font-size: 1.125rem;
    line-height: 1.6;
    text-align: center;
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.feature-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
}

.feature-card:hover {
    transform: translateY(-4px);
    border-color: var(--accent-blue);
    box-shadow: var(--shadow-secondary);
}

.feature-icon {
    font-size: 2.5rem;
    color: var(--accent-blue);
    margin-bottom: 1rem;
}

.feature-card h4 {
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
}

.feature-card p {
    color: var(--text-secondary);
    font-size: 0.875rem;
    text-align: center;
}

.steps-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-top: 2rem;
}

.step {
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.5rem;
}

.step-number {
    background: var(--gradient-brand);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.125rem;
    flex-shrink: 0;
}

.step-content h4 {
    color: var(--text-primary);
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.step-content p {
    color: var(--text-secondary);
    font-size: 0.875rem;
    text-align: left;
    margin: 0;
}
.upload-area:hover {
    background: linear-gradient(135deg, 
        rgba(255, 182, 193, 0.1) 0%, 
        rgba(186, 85, 211, 0.1) 25%, 
        rgba(138, 43, 226, 0.1) 50%, 
        rgba(75, 0, 130, 0.1) 75%, 
        rgba(255, 182, 193, 0.1) 100%);
}

.formats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.format-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.format-item:hover {
    border-color: var(--accent-blue);
    transform: translateY(-2px);
}

.format-icon {
    font-size: 2rem;
    color: var(--accent-blue);
    margin-bottom: 0.75rem;
}

.format-item span {
    color: var(--text-primary);
    font-weight: 500;
}
.back-to-home-btn {
    margin-right: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.back-to-home-btn:hover {
    transform: translateX(-2px);
}

.chat-item-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

.chat-item-title {
    flex: 1;
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
}

.chat-item.active .chat-item-title {
    color: var(--accent-blue);
}

.chat-item-menu {
    padding: 0.25rem;
    border-radius: 4px;
    cursor: pointer;
    color: var(--text-muted);
    opacity: 0;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
}

.chat-item:hover .chat-item-menu {
    opacity: 1;
}

.chat-item-menu:hover {
    background: var(--bg-accent);
    color: var(--text-primary);
}

.chat-menu {
    position: absolute;
    right: 0;
    top: 100%;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 0.5rem;
    z-index: 1000;
    min-width: 120px;
    box-shadow: var(--shadow-primary);
    margin-top: 0.25rem;
}

.chat-menu-option {
    padding: 0.5rem;
    color: var(--text-primary);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.chat-menu-option:hover {
    background: var(--bg-accent);
}

.chat-menu-option.delete {
    color: var(--accent-orange);
}

.chat-menu-option.delete:hover {
    background: rgba(248, 81, 73, 0.1);
}

.chat-item {
    position: relative;
}

.chat-item-title.editing {
    background: var(--bg-accent);
    border: 1px solid var(--accent-blue);
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    outline: none;
    white-space: nowrap;
    overflow: hidden;
    min-width: 100px;
}

.chat-area {
    width: 100%;
    padding: 2rem 0;
}

.chat-log-bubbles {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 100%;
}

.chat-bubble {
    max-width: 70%;
    padding: 1rem 1.5rem;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
}

.chat-bubble.user {
    align-self: flex-end;
    background: var(--accent-blue);
    color: white;
    border-bottom-right-radius: 4px;
}

.chat-bubble.ai {
    align-self: flex-start;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    color: var(--text-primary);
    border-bottom-left-radius: 4px;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.ai-bubble-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    margin-top: 0.25rem;
}
.typing-text {
    display: inline-block;
    min-height: 1.2em;
}
        
.ai-bubble-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.ai-bubble-content {
    flex: 1;
}

.chat-bubble-text {
    line-height: 1.5;
    margin: 0;
}

.bubble-copy-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    color: white;
    padding: 0.25rem;
    border-radius: 4px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
    font-size: 0.75rem;
}

.chat-bubble:hover .bubble-copy-btn {
    opacity: 1;
}

.bubble-copy-btn:hover {
    background: rgba(0, 0, 0, 0.7);
}
        
    </style>
</head>
<body>
    <div class="history-sidebar" id="historySidebar">
    <div class="sidebar-header">
        <button class="btn btn-primary new-chat-btn" onclick="createNewChat()">
            <i class="fas fa-plus"></i>
            New Chat
        </button>
        <button class="btn btn-outline home-btn" onclick="goHome()">
            <i class="fas fa-home"></i>
            Home
        </button>
    </div>
    <div class="chat-history-section">
        <h3 class="section-title">Recent Chats</h3>
        <div class="chat-list" id="chatList">
            <!-- Chat history items will be populated here -->
        </div>
    </div>
</div>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <header class="hero-section" id="heroSection">
    <nav class="nav-bar">
        <div class="nav-content">
            <div class="logo">
                <img src="./assets/iconwhite.png" alt="ClearViz Logo" class="logo-icon">
                <span class="logo-text">ClearViz</span>
            </div>
            <div class="nav-actions">
                <button class="btn btn-outline" id="helpButton">Help</button>
                <button class="btn btn-primary" onclick="scrollToUpload()">Get Started</button>
            </div>
        </div>
    </nav>
    
    <div class="hero-content">
        <div class="hero-badge">
            <i class="fas fa-chart-line"></i>
            100% DATA-DRIVEN
        </div>
        <h1 class="hero-title">
            <span class="hero-highlight typing-text" id="typingText"></span><span class="typing-cursor">|</span><span class="data-reimagined">, Data Reimagined.</span>
        </h1>
        <p class="hero-subtitle animated-subtitle">
            ClearViz transforms your raw data into beautiful, insightful visualizations
        </p>
        
        <div class="ai-chatbox-hero" id="aiChatboxHero">
    <div class="chatbox-header">
        <div class="chatbox-title">How can I help you today?</div>
        <div class="chatbox-subtitle">Start by uploading your raw data in the forms of CSV, Excel, or JSON.</div>
    </div>
    <div class="chatbox-input-container">
        <div class="chatbox-input-wrapper">
            <div class="file-upload-btn" onclick="document.getElementById('heroFileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <input type="text" class="chatbox-input" placeholder="Ask about your data..." id="heroPromptInput">
            <div class="model-selector-btn" id="heroModelBtn" onclick="toggleModelDropdown()">
                <span id="selectedModelText">Llama 3</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <button class="send-btn" id="heroSendBtn" onclick="sendHeroMessage()">
                <i class="fas fa-arrow-up"></i>
            </button>
        </div>
        <div class="model-dropdown" id="modelDropdown">
            <div class="model-option selected" data-model="llama3" onclick="selectModel('llama3')">
                <i class="fas fa-check"></i> Llama 3
            </div>
            <div class="model-option" data-model="llama4-maverick" onclick="selectModel('llama4-maverick')">
                <i class="fas fa-check"></i> Llama 4 Maverick
            </div>
            <div class="model-option" data-model="llama4-scout" onclick="selectModel('llama4-scout')">
                <i class="fas fa-check"></i> Llama 4 Scout
            </div>
            <div class="model-option disabled">
                <i class="fas fa-clock"></i> More models coming soon
            </div>
        </div>
    </div>
    <input type="file" id="heroFileInput" style="display: none;" accept=".csv,.xlsx,.xls,.json,image/*,.pdf" onchange="handleHeroFile(event)">
    <div class="file-preview" id="heroFilePreview" style="display: none;">
        <div class="file-preview-content">
            <span class="file-name"></span>
            <button class="file-remove-btn" onclick="removeHeroFile()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>
        </div>
    </div>
</header>

<header class="modern-header" id="dataHeader" style="display: none;">
    <div class="header-content">
        <div class="header-left">
            <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <img src="./assets/iconwhite.png" alt="ClearViz Logo" class="logo-icon">
            <span class="logo-text">ClearViz</span>
        </div>
        <div class="header-center">
            <div class="chat-title-container">
                <span class="chat-title-text" id="chatTitleDisplay" contenteditable="true" onclick="enableTitleEdit(this)">Your Chat History</span>
            </div>
        </div>
        <div class="header-actions">
    <button class="btn btn-outline" onclick="showHelpPage()">Help</button>
    <button class="btn btn-outline export-chat-btn" onclick="exportChat()" title="Export Chat">
        <i class="fas fa-download"></i>
    </button>
</div>
    </div>
</header>

    <div class="main-container" id="mainContainer" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3 class="section-title">Data Source</h3>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Upload more data</div>
                    <div class="upload-subtext">CSV, Excel, or JSON files</div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls,.json" onchange="handleFile(event)">
                <div id="fileList" class="file-list"></div>
            </div>

            <div class="sidebar-section" id="chartTypeSection" style="display: none;">
                <h3 class="section-title">Chart Type</h3>
                <div class="chart-types">
                    <div class="chart-type-btn active" data-type="bar" onclick="selectChartType('bar')">
                        <i class="fas fa-chart-bar"></i>
                        Bar Chart
                    </div>
                    <div class="chart-type-btn" data-type="line" onclick="selectChartType('line')">
                        <i class="fas fa-chart-line"></i>
                        Line Chart
                    </div>
                    <div class="chart-type-btn" data-type="pie" onclick="selectChartType('pie')">
                        <i class="fas fa-chart-pie"></i>
                        Pie Chart
                    </div>
                    <div class="chart-type-btn" data-type="regression" onclick="selectChartType('regression')">
                        <i class="fas fa-arrow-up"></i>
                        Regression
                    </div>
                </div>
            </div>

            <div class="sidebar-section" id="axisSection" style="display: none;">
                <h3 class="section-title">Data Mapping</h3>
                <div class="axis-selectors">
                    <div class="axis-selector-group">
                        <label class="form-label">X-Axis (Categories)</label>
                        <div class="claude-dropdown" id="xAxisDropdown">
                            <div class="claude-dropdown-button" onclick="toggleDropdown('xAxis')">
                                <div class="claude-dropdown-content">
                                    <div class="claude-dropdown-title" id="xAxisSelected">Select column...</div>
                                </div>
                                <div class="claude-dropdown-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                            <div class="claude-dropdown-menu" id="xAxisMenu">
                                <!-- Options will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="axis-selector-group">
                        <label class="form-label">Y-Axis (Values)</label>
                        <div class="claude-dropdown" id="yAxisDropdown">
                            <div class="claude-dropdown-button" onclick="toggleDropdown('yAxis')">
                                <div class="claude-dropdown-content">
                                    <div class="claude-dropdown-title" id="yAxisSelected">Select column...</div>
                                </div>
                                <div class="claude-dropdown-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                            <div class="claude-dropdown-menu" id="yAxisMenu">
                                <!-- Options will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="axis-selectors" style="margin-top: 1rem;">
                    <div class="axis-selector-group">
                        <label class="form-label">X-Axis Title</label>
                        <input type="text" class="form-input" id="xAxisTitle" placeholder="X-Axis Title" onchange="updateChart()">
                    </div>
                    <div class="axis-selector-group">
                        <label class="form-label">Y-Axis Title</label>
                        <input type="text" class="form-input" id="yAxisTitle" placeholder="Y-Axis Title" onchange="updateChart()">
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div id="statusMessage"></div>

            <div class="content-card full-height" id="chartCard">
                <div class="card-header" style="justify-content: space-between;">
    <h2 class="card-title">
        <i class="fas fa-chart-area"></i>
        <span id="autoGeneratedChartTitle">Visualization</span>
    </h2>
    <div class="header-right-controls">
        <button class="btn btn-outline chart-popup-btn" onclick="openChartInNewWindow()" title="Open in new window">
            <i class="fas fa-external-link-alt"></i>
        </button>
        <button class="btn btn-primary" onclick="exportChart()">Export Chart</button>
        <div id="regressionToggleWrapper" style="display: none; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="toggleRegression" onchange="updateChart()" />
            Show Regression Line
        </div>
    </div>
</div>
                <div id="chartContainer" class="chart-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="empty-state-title">No Data Yet</div>
                        <div class="empty-state-text">Upload a data file to get started with your visualization</div>
                    </div>
                    <canvas id="chart""></canvas>
                    <div id="regressionEquation" class="regression-equation" style="display: none;"></div>
                </div>
            </div>
            <div class="content-card" id="insightsCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-lightbulb"></i>
                        Insights
                    </h2>
                </div>
                <div class="card-content">
                    <div id="insightsScrollWrapper" style="max-height: 300px; overflow: auto;">
                        <div id="insightsContainer" class="insights-grid"></div>
                    </div>
                </div>
            </div>
            <div class="floating-chatbox" id="floatingChatbox" style="display: none;">
                <div class="floating-chatbox-header">
                    <div class="chatbox-title">What insights/models can I provide you with?</div>
                </div>
                <div class="floating-chatbox-input">
                    <div class="chatbox-input-wrapper">
                        <input type="text" class="chatbox-input" placeholder="Ask about your data..." id="dataPromptInput">
                        <div class="model-selector-btn" onclick="toggleDataModelDropdown()">
                            <span id="selectedDataModelText">Llama 3</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <button class="send-btn" onclick="sendDataMessage()">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                    <div class="model-dropdown" id="dataModelDropdown">
                        <div class="model-option selected" data-model="llama3" onclick="selectDataModel('llama3')">
                            <i class="fas fa-check"></i> Llama 3
                        </div>
                        <div class="model-option" data-model="llama4-maverick" onclick="selectDataModel('llama4-maverick')">
                            <i class="fas fa-check"></i> Llama 4 Maverick
                        </div>
                        <div class="model-option" data-model="llama4-scout" onclick="selectDataModel('llama4-scout')">
                            <i class="fas fa-check"></i> Llama 4 Scout
                        </div>
                        <div class="model-option disabled">
                            <i class="fas fa-clock"></i> More models coming soon
                        </div>
                    </div>
                </div>
            </div>
            <div class="chat-area" id="chatArea" style="display: none;">
                <div id="chatLog" class="chat-log-bubbles"></div>
        </main>
    </div>
    <div class="help-page" id="helpPage" style="display: none;">
    <header class="help-header">
    <div class="help-header-content">
        <div class="header-left">
            <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <button class="btn btn-outline back-to-home-btn" onclick="goHome()" title="Back to Home">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <img src="./assets/iconwhite.png" alt="ClearViz Logo" class="logo-icon">
            <span class="logo-text">ClearViz</span>
        </div>
        <div class="header-center">
            <h1 class="help-page-title">What is ClearViz?</h1>
        </div>
    </div>
</header>
    
    <div class="help-content">
        <div class="help-section">
            <h2>Transform Your Data Into Insights</h2>
            <p>ClearViz is a powerful data visualization tool that transforms your raw data into beautiful, meaningful visualizations. Whether you're working with CSV files, Excel spreadsheets, or JSON data, ClearViz makes it easy to create compelling charts and discover valuable insights.</p>
        </div>
        
        <div class="help-section">
            <h3>Key Features</h3>
            <div class="features-grid">
                <div class="feature-card">
                    <i class="fas fa-upload feature-icon"></i>
                    <h4>Easy Data Upload</h4>
                    <p>Simply drag and drop your CSV, Excel, or JSON files to get started.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-chart-bar feature-icon"></i>
                    <h4>Multiple Chart Types</h4>
                    <p>Create bar charts, line graphs, pie charts, and regression analyses.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-robot feature-icon"></i>
                    <h4>AI-Powered Insights</h4>
                    <p>Get intelligent analysis and insights about your data with our AI assistant.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-download feature-icon"></i>
                    <h4>Export & Share</h4>
                    <p>Export your visualizations and chat conversations for presentations.</p>
                </div>
            </div>
        </div>
        
        <div class="help-section">
            <h3>How to Get Started</h3>
            <div class="steps-container">
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Upload Your Data</h4>
                        <p>Click the upload area or drag and drop your data file (CSV, Excel, or JSON).</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Choose Your Visualization</h4>
                        <p>Select the chart type that best represents your data and choose your X and Y axes.</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Ask Questions</h4>
                        <p>Use our AI assistant to ask questions about your data and get deeper insights.</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>Export & Share</h4>
                        <p>Export your charts as images or save your entire conversation for later reference.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="help-section">
            <h3>Supported File Formats</h3>
            <div class="formats-grid">
                <div class="format-item">
                    <i class="fas fa-file-csv format-icon"></i>
                    <span>CSV Files</span>
                </div>
                <div class="format-item">
                    <i class="fas fa-file-excel format-icon"></i>
                    <span>Excel Files (.xlsx, .xls)</span>
                </div>
                <div class="format-item">
                    <i class="fas fa-file-code format-icon"></i>
                    <span>JSON Files</span>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        let currentData = null;
        let currentChart = null;
        let selectedChartType = 'bar';
        let uploadedFiles = [];
        let currentFileIndex = 0;
        // 1. ADD this isValidDataForChart function right after the global variables section
function isValidDataForChart(xColumn, yColumn, chartType) {
    if (!currentData || currentData.length === 0) {
        showMessage('No data available for chart', 'error');
        return false;
    }
    
    if (!xColumn || !yColumn) {
        showMessage('Please select both X and Y axis columns', 'error');
        return false;
    }
    
    // Check if columns exist in data
    const columns = Object.keys(currentData[0]);
    if (!columns.includes(xColumn) || !columns.includes(yColumn)) {
        showMessage('Selected columns not found in data', 'error');
        return false;
    }
    
    // For pie and doughnut charts, Y column should be numeric
    if (['pie', 'doughnut'].includes(chartType)) {
        const yValues = currentData.slice(0, 5).map(row => row[yColumn]);
        const numericCount = yValues.filter(val => {
            if (typeof val === 'number') return true;
            if (typeof val === 'string') {
                const num = parseFloat(val.replace(/[,$%]/g, ''));
                return !isNaN(num) && isFinite(num);
            }
            return false;
        }).length;
        
        if (numericCount === 0) {
            showMessage('Y-axis column must contain numeric values for this chart type', 'error');
            return false;
        }
    }
    
    return true;
}

// 2. ADD this prepareChartData function right after isValidDataForChart
function prepareChartData(xColumn, yColumn, chartType, maxRows = 20) {
    if (!currentData || currentData.length === 0) return null;
    
    // Limit and clean data
    let processedData = currentData.slice(0, maxRows);
    
    // Group data by x-axis values and sum y-axis values
    const groupedData = {};
    
    processedData.forEach(row => {
        const xValue = String(row[xColumn] || 'Unknown');
        const yValue = row[yColumn];
        
        // Convert y value to number
        let numericY = 0;
        if (typeof yValue === 'number') {
            numericY = yValue;
        } else if (typeof yValue === 'string') {
            const parsed = parseFloat(yValue.replace(/[,$%]/g, ''));
            numericY = !isNaN(parsed) && isFinite(parsed) ? parsed : 0;
        }
        
        if (groupedData[xValue]) {
            groupedData[xValue] += numericY;
        } else {
            groupedData[xValue] = numericY;
        }
    });
    
    // Convert to arrays for Chart.js
    const labels = Object.keys(groupedData);
    const values = Object.values(groupedData);
    
    // Generate colors
    const colors = generateColors(labels.length);
    
    return {
        labels: labels,
        datasets: [{
            label: yColumn,
            data: values,
            backgroundColor: colors.background,
            borderColor: colors.border,
            borderWidth: 2,
            tension: 0.4
        }]
    };
}

// 3. ADD this generateColors helper function
function generateColors(count) {
    const baseColors = [
        'rgba(88, 166, 255, 0.8)',   // Blue
        'rgba(188, 140, 255, 0.8)',  // Purple
        'rgba(63, 185, 80, 0.8)',    // Green
        'rgba(248, 81, 73, 0.8)',    // Red
        'rgba(210, 153, 34, 0.8)',   // Yellow
        'rgba(255, 99, 132, 0.8)',   // Pink
        'rgba(54, 162, 235, 0.8)',   // Light Blue
        'rgba(255, 159, 64, 0.8)'    // Orange
    ];
    
    const borderColors = [
        'rgba(88, 166, 255, 1)',
        'rgba(188, 140, 255, 1)',
        'rgba(63, 185, 80, 1)',
        'rgba(248, 81, 73, 1)',
        'rgba(210, 153, 34, 1)',
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 159, 64, 1)'
    ];
    
    const background = [];
    const border = [];
    
    for (let i = 0; i < count; i++) {
        background.push(baseColors[i % baseColors.length]);
        border.push(borderColors[i % borderColors.length]);
    }
    
    return { background, border };
}

// 4. ADD this renderChart function (the most important missing piece)
function renderChart(chartType, chartData) {
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    
    if (currentChart) {
        currentChart.destroy();
    }

    document.querySelector('.empty-state').style.display = 'none';
    canvas.style.display = 'block';

    if (chartType === 'regression') {
    chartType = 'line';

    // Add regression line if checkbox is checked
    if (document.getElementById('toggleRegression').checked) {
        // Calculate regression for the original data
        const points = chartData.labels.map((label, index) => ({
            x: index,
            y: chartData.datasets[0].data[index]
        }));
        
        const regression = calculateLinearRegression(points);
        const regressionYValues = chartData.labels.map((label, index) => 
            regression.slope * index + regression.intercept
        );
        
        // Make original data show as points only
        chartData.datasets[0].showLine = false;
        chartData.datasets[0].pointRadius = 4;
        chartData.datasets[0].backgroundColor = 'rgba(88, 166, 255, 1)';
        
        // Add regression line as second dataset
        chartData.datasets.push({
            label: 'Regression Line',
            data: regressionYValues,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0)',
            borderWidth: 3,
            fill: false,
            pointRadius: 0,
            showLine: true,
            tension: 0
        });

        showRegressionEquation(regression.slope, regression.intercept);
    } else {
        chartData.datasets[0].showLine = false;
        chartData.datasets[0].pointRadius = 4;
        chartData.datasets[0].backgroundColor = 'rgba(88, 166, 255, 1)';
        hideRegressionEquation();
    }
} else {
    hideRegressionEquation();
}
    // Chart configuration
    const xTitle = document.getElementById('xAxisTitle')?.value || selectedXAxis || 'X-Axis';
    const yTitle = document.getElementById('yAxisTitle')?.value || selectedYAxis || 'Y-Axis';
    const showAxes = !['pie', 'doughnut'].includes(chartType);

const config = {
    type: chartType,
    data: chartData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: showAxes ? {
            y: {
                maxHeight: 500,
                title: {
                    display: true,
                    text: yTitle,
                    color: '#f0f6fc',
                    font: {
                        size: 14,
                        weight: '500'
                    }
                }
            },
            x: {
                maxHeight: 500,
                title: {
                    display: true,
                    text: xTitle,
                    color: '#f0f6fc',
                    font: {
                        size: 14,
                        weight: '500'
                    }
                }
            }
        } : {}
    }
};

    if (['bar', 'line', 'scatter'].includes(chartType)) {
    config.options.scales.x = {
        ...config.options.scales.x,
        ticks: { color: '#8b949e' },
        grid: { color: '#30363d' }
    };
    config.options.scales.y = {
        ...config.options.scales.y,
        ticks: { color: '#8b949e' },
        grid: { color: '#30363d' }
    };
}
    currentChart = new Chart(ctx, config);
}

function generateInsights(chartType, xColumn, yColumn, chartData) {
    if (!chartData || !chartData.datasets || chartData.datasets.length === 0) return;

    const values = chartData.datasets[0].data;
    const labels = chartData.labels;
    if (!values || values.length === 0) return;

    let insights = [];

    if (chartType === 'bar') {
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        const stdDev = Math.sqrt(values.map(v => (v - avg) ** 2).reduce((a, b) => a + b) / values.length);
        const max = Math.max(...values);
        const maxLabel = labels[values.indexOf(max)];
        const range = parseFloat(labels[labels.length - 1]) - parseFloat(labels[0]);

        insights = [
            { value: avg.toFixed(2), label: `Average ${yColumn}` },
            { value: max.toFixed(2), label: `Highest ${yColumn}` },
            { value: stdDev.toFixed(2), label: `Std Dev of ${yColumn}` },
            { value: isNaN(range) ? 'N/A' : range.toFixed(2), label: `Data Range (X)` },
            { value: values.length, label: 'Total Points' },
            { value: (max / avg).toFixed(2), label: 'Max/Average Ratio' }
        ];
    } else if (chartType === 'pie') {
        const max = Math.max(...values);
        const maxLabel = labels[values.indexOf(max)];
        const total = values.reduce((a, b) => a + b, 0);
        const avg = total / values.length;

        insights = [
            { value: maxLabel, label: `Largest Sector` },
            { value: max.toFixed(2), label: `Largest Value` },
            { value: total.toFixed(2), label: `Total ${yColumn}` },
            { value: avg.toFixed(2), label: `Average ${yColumn}` },
            { value: labels.length, label: `Categories` },
            { value: (max / total * 100).toFixed(1) + '%', label: `% of Largest` }
        ];
    } else if (chartType === 'line') {
        const diffs = values.slice(1).map((v, i) => v - values[i]);
        const avgDiff = diffs.reduce((a, b) => a + b, 0) / diffs.length;
        const slope = ((values.at(-1) - values[0]) / values.length).toFixed(2);

        insights = [
            { value: slope, label: `Avg Slope` },
            { value: values[0].toFixed(2), label: `Start ${yColumn}` },
            { value: values.at(-1).toFixed(2), label: `End ${yColumn}` },
            { value: avgDiff.toFixed(2), label: `Avg Change/Point` },
            { value: values.length, label: 'Total Points' },
            { value: labels.length, label: 'X Range' }
        ];
    } else if (chartType === 'regression' || chartType === 'scatter') {
    // Create points from the chart data for regression calculation
    const dataPoints = chartData.labels.map((label, index) => ({
        x: index,
        y: chartData.datasets[0].data[index]
    }));
    
    const n = dataPoints.length;
    if (n < 2) {
        insights = [
            { value: 'N/A', label: `r-value` },
            { value: 'N/A', label: `r² value` },
            { value: 'N/A', label: `Slope (β)` },
            { value: 'N/A', label: `Y-intercept` },
            { value: 'N/A', label: `SE of Slope` },
            { value: 'N/A', label: `SE of Intercept` }
        ];
    } else {
        const xs = dataPoints.map(p => p.x);
        const ys = dataPoints.map(p => p.y);

        const xMean = xs.reduce((a, b) => a + b, 0) / n;
        const yMean = ys.reduce((a, b) => a + b, 0) / n;

        const ssXX = xs.reduce((sum, x) => sum + Math.pow(x - xMean, 2), 0);
        const ssYY = ys.reduce((sum, y) => sum + Math.pow(y - yMean, 2), 0);
        const ssXY = xs.reduce((sum, x, i) => sum + (x - xMean) * (ys[i] - yMean), 0);

        // Avoid division by zero
        if (ssXX === 0 || ssYY === 0) {
            insights = [
                { value: '0.0000', label: `r-value` },
                { value: '0.0000', label: `r² value` },
                { value: ssXX === 0 ? 'Undefined' : '0.0000', label: `Slope (β)` },
                { value: yMean.toFixed(4), label: `Y-intercept` },
                { value: 'N/A', label: `SE of Slope` },
                { value: 'N/A', label: `SE of Intercept` }
            ];
        } else {
            const slope = ssXY / ssXX;
            const intercept = yMean - slope * xMean;

            const predictedYs = xs.map(x => slope * x + intercept);
            const residuals = ys.map((y, i) => y - predictedYs[i]);

            const se = n > 2 ? Math.sqrt(residuals.reduce((sum, r) => sum + r ** 2, 0) / (n - 2)) : 0;
            const seSlope = ssXX > 0 && se > 0 ? se / Math.sqrt(ssXX) : 0;
            const seIntercept = se > 0 ? se * Math.sqrt((1 / n) + (xMean ** 2 / ssXX)) : 0;

            const r = ssXY / Math.sqrt(ssXX * ssYY);
            const r2 = r * r;

            insights = [
                { value: isNaN(r) ? 'N/A' : r.toFixed(4), label: `r-value` },
                { value: isNaN(r2) ? 'N/A' : r2.toFixed(4), label: `r² value` },
                { value: isNaN(slope) ? 'N/A' : slope.toFixed(4), label: `Slope (β)` },
                { value: isNaN(intercept) ? 'N/A' : intercept.toFixed(4), label: `Y-intercept` },
                { value: isNaN(seSlope) || seSlope === 0 ? 'N/A' : seSlope.toFixed(4), label: `SE of Slope` },
                { value: isNaN(seIntercept) || seIntercept === 0 ? 'N/A' : seIntercept.toFixed(4), label: `SE of Intercept` }
            ];
        }
    }
}
    const insightsContainer = document.getElementById('insightsContainer');
    insightsContainer.innerHTML = insights.map(insight => `
        <div class="insight-card">
            <div class="insight-value">${insight.value}</div>
            <div class="insight-label">${insight.label}</div>
        </div>
    `).join('');
}



        // File upload and processing
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
                event.target.value = '';
            }    
        }

        function processFile(file) {
            showMessage(`Processing ${file.name}...`, 'success');
            showDataPage();
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                parseCSV(file);
            } else if (['xlsx', 'xls'].includes(fileExtension)) {
                parseExcel(file);
            } else if (fileExtension === 'json') {
                parseJSON(file);
            } else {
                showMessage('Unsupported file format. Please upload CSV, Excel, or JSON files.', 'error');
            }
        }

        function parseCSV(file) {
            Papa.parse(file, {
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showMessage('Error parsing CSV: ' + results.errors[0].message, 'error');
                        return;
                    }
                    const cleanData = results.data.filter(row => {
                        return Object.values(row).some(value => value !== null && value !== undefined && value !== '');
                    }).map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            const value = row[key];
                            if (typeof value === 'string' && value.trim() !== '') {
                                const numValue = parseFloat(value.replace(/[,$%]/g, ''));
                                if (!isNaN(numValue) && isFinite(numValue)) {
                                    cleanRow[key.trim()] = numValue;
                                } else {
                                    cleanRow[key.trim()] = value.trim();
                                }
                            } else {
                                cleanRow[key.trim()] = value;
                            }
                        });
                        return cleanRow;
                    });
                    processData(cleanData, file.name);
                },
                header: true,
                skipEmptyLines: true,
                transformHeader: function(header) {
                    return header.trim();
                }
            });
        }

        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    const cleanData = jsonData.filter(row => {
                        return row && typeof row === 'object' && Object.keys(row).length > 0;
                    }).map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            const value = row[key];
                            if (typeof value === 'string' && value.trim() !== '') {
                                const numValue = parseFloat(value.replace(/[,$%]/g, ''));
                                if (!isNaN(numValue) && isFinite(numValue)) {
                                    cleanRow[key.trim()] = numValue;
                                } else {
                                    cleanRow[key.trim()] = value.trim();
                                }
                            } else {
                                cleanRow[key.trim()] = value;
                            }
                        });
                        return cleanRow;
                    });
                    processData(cleanData, file.name);
                } catch (error) {
                    showMessage('Error parsing Excel file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseJSON(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    if (Array.isArray(jsonData)) {
                        const cleanData = jsonData.filter(row => {
                        return row && typeof row === 'object' && Object.keys(row).length > 0;
                    }).map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            const value = row[key];
                            if (typeof value === 'string' && value.trim() !== '') {
                                const numValue = parseFloat(value.replace(/[,$%]/g, ''));
                                if (!isNaN(numValue) && isFinite(numValue)) {
                                    cleanRow[key.trim()] = numValue;
                                } else {
                                    cleanRow[key.trim()] = value.trim();
                                }
                            } else {
                                cleanRow[key.trim()] = value;
                            }
                        });
                        return cleanRow;
                    });
                    processData(cleanData, file.name);
                    } else {
                        showMessage('JSON file must contain an array of objects', 'error');
                    }
                } catch (error) {
                    showMessage('Error parsing JSON: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

function processData(data, filename) {
    if (!data || data.length === 0) {
        showMessage('No data found in the file', 'error');
        return;
    }

    const validRows = data.filter(row => row && typeof row === 'object' && Object.keys(row).length > 0);
    
    if (validRows.length === 0) {
        showMessage('No valid data rows found in the file', 'error');
        return;
    }

    currentData = validRows;
    showMessage(`Successfully loaded ${validRows.length} rows from ${filename}`, 'success');

    if (!currentChatId) {
        const chatId = Date.now().toString();
        const newChat = {
            id: chatId,
            title: filename.replace(/\.[^/.]+$/, ""),
            files: [],
            messages: [],
            createdAt: new Date()
        };
        
        chatHistory.unshift(newChat);
        currentChatId = chatId;
        updateChatList();

        setTimeout(() => {
            generateChatTitle(filename);
        }, 1000);
    }

    const currentChat = chatHistory.find(c => c.id === currentChatId);
    if (currentChat) {
        addFileToList(validRows, filename);
        currentChat.files = uploadedFiles;
    }
    
    // ADD THIS LINE TO SHOW INSIGHTS IMMEDIATELY:
    showDataPreviewAndInsights();
}
function showDataPreviewAndInsights() {
    if (!currentData || currentData.length === 0) return;
    
    // Show the insights card
    document.getElementById('insightsCard').style.display = 'block';
    
    // Generate basic data insights without requiring chart
    const columns = Object.keys(currentData[0]);
    const rowCount = currentData.length;
    const numericColumns = columns.filter(col => {
        return currentData.slice(0, 5).some(row => {
            const val = row[col];
            return typeof val === 'number' || (typeof val === 'string' && !isNaN(parseFloat(val)));
        });
    });
    
    const insights = [
        { value: rowCount.toLocaleString(), label: 'Total Rows' },
        { value: columns.length, label: 'Total Columns' },
        { value: numericColumns.length, label: 'Numeric Columns' },
        { value: (columns.length - numericColumns.length), label: 'Text Columns' },
        { value: columns[0] || 'N/A', label: 'First Column' },
        { value: columns[columns.length - 1] || 'N/A', label: 'Last Column' }
    ];
    
    const insightsContainer = document.getElementById('insightsContainer');
    insightsContainer.innerHTML = insights.map(insight => `
        <div class="insight-card">
            <div class="insight-value">${insight.value}</div>
            <div class="insight-label">${insight.label}</div>
        </div>
    `).join('');
}

        function populateColumnSelectors() {
            const xMenu = document.getElementById('xAxisMenu');
            const yMenu = document.getElementById('yAxisMenu');
    
            xMenu.innerHTML = '';
            yMenu.innerHTML = '';

            if (!currentData || currentData.length === 0) return;

            const columns = Object.keys(currentData[0]);
    
            columns.forEach(column => {
                const xOption = document.createElement('div');
                xOption.className = 'claude-dropdown-option';
                xOption.textContent = column;
                xOption.onclick = () => selectColumn('xAxis', column);
                xMenu.appendChild(xOption);
                const yOption = document.createElement('div');
                yOption.className = 'claude-dropdown-option';
                yOption.textContent = column;
                yOption.onclick = () => selectColumn('yAxis', column);
                yMenu.appendChild(yOption);
            });
        }

        function showDataPreview() {
            const previewCard = document.getElementById('previewCard');
            const previewTable = document.getElementById('previewTable');
            
            if (!currentData || currentData.length === 0) return;

            const columns = Object.keys(currentData[0]);
            const previewRows = currentData.slice(0, 5);

            let html = '<table class="preview-table"><thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            previewRows.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col];
                    const displayValue = (value === null || value === undefined) ? '' : String(value);
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            previewTable.innerHTML = html;
            previewCard.style.display = 'block';
        }

        function selectChartType(type) {
        selectedChartType = type;
    
            if (uploadedFiles[currentFileIndex]) {
                uploadedFiles[currentFileIndex].chartType = type;
            }
    
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-type="${type}"]`).classList.add('active');
    
        updateChart();

        const regressionToggle = document.getElementById('regressionToggleWrapper');
        if (type === 'regression') {
            regressionToggle.style.display = 'flex';
        } else {
            regressionToggle.style.display = 'none';
            document.getElementById('toggleRegression').checked = false;
        }
    }

function updateChart() {
    // Save current file settings
    if (uploadedFiles[currentFileIndex]) {
        uploadedFiles[currentFileIndex].xAxisTitle = document.getElementById('xAxisTitle').value || '';
        uploadedFiles[currentFileIndex].yAxisTitle = document.getElementById('yAxisTitle').value || '';
    }
    
    const xColumn = selectedXAxis;
    const yColumn = selectedYAxis;
    const maxRows = 20;

    // Show empty state if no axes selected
    if (!xColumn || !yColumn || !currentData) {
        showEmptyChart();
        return;
    }

    if (!isValidDataForChart(xColumn, yColumn, selectedChartType)) {
        return;
    }

    showChartLoading();

    const chartData = prepareChartData(xColumn, yColumn, selectedChartType, maxRows);
    renderChart(selectedChartType, chartData);
    generateInsights(selectedChartType, xColumn, yColumn, chartData);
    if (selectedXAxis && selectedYAxis) {
    setTimeout(() => {
        generateChartTitle(selectedXAxis, selectedYAxis, selectedChartType);
    }, 500);
}
}
function showEmptyChart() {
    const chartContainer = document.getElementById('chartContainer');
    const canvas = document.getElementById('chart');
    const emptyState = chartContainer.querySelector('.empty-state');
    
    // Hide canvas and destroy existing chart
    canvas.style.display = 'none';
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
    
    // Show empty state
    if (emptyState) {
        emptyState.innerHTML = `
            <div class="empty-state-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="empty-state-title">Choose Axis Options</div>
            <div class="empty-state-text">Select both X and Y axis columns to view your visualization</div>
        `;
        emptyState.style.display = 'flex';
    }
    
    // Clear insights
    document.getElementById('insightsContainer').innerHTML = '';
}
function showChartLoading() {
    const chartContainer = document.getElementById('chartContainer');
    const emptyState = chartContainer.querySelector('.empty-state');
    
    if (emptyState) {
        emptyState.innerHTML = `
            <div class="chart-loading">
                <div class="spinner"></div>
                <div class="empty-state-title">Generating Chart...</div>
                <div class="empty-state-text">Processing your data</div>
            </div>
        `;
        emptyState.style.display = 'flex';
    }
}

function exportChart() {
    if (!currentChart || uploadedFiles.length === 0) {
        showMessage('No chart to export', 'error');
        return;
    }
    
    const currentFile = uploadedFiles[currentFileIndex];
    const canvas = document.getElementById('chart');
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    
    const baseName = currentFile.name.replace(/\.[^/.]+$/, ""); 
    link.download = `${baseName}_${currentFile.chartType}_chart.png`;
    link.href = url;
    
    let downloadStarted = false;
    
    link.addEventListener('click', function() {
        downloadStarted = true;
    });

    const handleFocus = function() {
        if (downloadStarted) {
            setTimeout(() => {
                showMessage(`Chart exported: ${baseName}_${currentFile.chartType}_chart.png`, 'success');
                downloadStarted = false;
                window.removeEventListener('focus', handleFocus);
            }, 500);
        }
    };
    
    window.addEventListener('focus', handleFocus);
    
    link.click();
}

// 3. ADD missing showHelp function
function showHelp() {
    const helpText = `
How to use this tool:
1. Upload a CSV, Excel, or JSON file
2. Select columns for X and Y axes
3. Choose your chart type
4. View your visualization and insights

Supported formats: .csv, .xlsx, .xls, .json
    `;
    alert(helpText);
}

// 4. FIX the canvas sizing issue (VERY IMPORTANT)
function fixCanvasSize() {
    const canvas = document.getElementById('chart');
    const container = document.getElementById('chartContainer');
    
    // Set explicit dimensions
    canvas.style.width = '100%';
    canvas.style.height = '400px';
    canvas.height = 400;
    
    // Force container dimensions
    container.style.width = '100%';
    container.style.height = '500px';
    container.style.position = 'relative';
}
// Also update the existing drag and drop for hero area
const heroUploadArea = document.getElementById('heroUploadArea');
if (heroUploadArea) {
   heroUploadArea.addEventListener('dragover', (e) => {
       e.preventDefault();
       heroUploadArea.style.borderColor = 'var(--accent-blue)';
       heroUploadArea.style.background = 'rgba(88, 166, 255, 0.05)';
   });

   heroUploadArea.addEventListener('dragleave', () => {
       heroUploadArea.style.borderColor = 'var(--border-primary)';
       heroUploadArea.style.background = 'var(--bg-secondary)';
   });

   heroUploadArea.addEventListener('drop', (e) => {
       e.preventDefault();
       heroUploadArea.style.borderColor = 'var(--border-primary)';
       heroUploadArea.style.background = 'var(--bg-secondary)';
       const files = e.dataTransfer.files;
       if (files.length > 0) {
           processFile(files[0]);
       }
   });
}
        
function showMessage(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    const mainContent = document.querySelector('.main-content');
    
    statusDiv.innerHTML = `<div class="status-message status-${type}"><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>${message}</div>`;
    
    if (mainContent) {
        mainContent.style.marginTop = '0';
    }
    
    setTimeout(() => {
        statusDiv.innerHTML = '';
        if (mainContent) {
            mainContent.style.marginTop = '-60px';
        }
    }, 5000);
}


// Page Navigation Functions
function goHome() {
    // Hide data visualization page
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('dataHeader').style.display = 'none';
    
    // Reset hero section for animation
    const heroSection = document.getElementById('heroSection');
    heroSection.classList.add('hide-animations');
    heroSection.style.display = 'block';
    
    // Force a reflow to ensure the class is applied
    heroSection.offsetHeight;
    
    // Remove the class to trigger animations
    setTimeout(() => {
        heroSection.classList.remove('hide-animations');
        
        // Reset individual elements for animation
        const elementsToAnimate = [
            '.nav-bar',
            '.hero-content',
            '.hero-badge',
            '.hero-title', 
            '.hero-subtitle',
            '.ai-chatbox-hero'
        ];
        
        elementsToAnimate.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.style.opacity = '0';
                element.style.transform = selector === '.nav-bar' ? 'translateY(-30px)' : 'translateY(30px)';
                element.style.animation = 'none';
                
                // Force reflow
                element.offsetHeight;
                
                // Re-enable animation
                element.style.animation = '';
            }
        });
    }, 50);
    
    // Reset data and charts
    currentData = null;
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
    
    document.getElementById('fileInput').value = '';
    uploadedFiles = [];
    currentFileIndex = 0;
    selectedXAxis = '';
    selectedYAxis = '';
    document.getElementById('xAxisSelected').textContent = 'Select column...';
    document.getElementById('yAxisSelected').textContent = 'Select column...';
    document.getElementById('xAxisMenu').innerHTML = '';
    document.getElementById('yAxisMenu').innerHTML = '';
    document.getElementById('fileList').innerHTML = '';
    
    // Hide sections
    document.getElementById('chartTypeSection').style.display = 'none';
    document.getElementById('axisSection').style.display = 'none';
    document.getElementById('insightsCard').style.display = 'none';
    document.getElementById('insightsContainer').innerHTML = '';
    
    // Reset chart container
    const chartContainer = document.getElementById('chartContainer');
    const emptyState = chartContainer.querySelector('.empty-state');
    if (emptyState) {
        emptyState.innerHTML = `
            <div class="empty-state-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="empty-state-title">No Data Yet</div>
            <div class="empty-state-text">Upload a data file to get started with your visualization</div>
        `;
    }
    document.getElementById('chart').style.display = 'none';

    document.getElementById('statusMessage').innerHTML = '';
    
    showMessage('Returned to home page', 'success');

    setTimeout(startTypingAnimation, 100);
}

function showDataPage() {
    // Add class to disable animations when hiding
    const heroSection = document.getElementById('heroSection');
    heroSection.classList.add('hide-animations');
    
    // Hide home page
    heroSection.style.display = 'none';
    document.getElementById('helpPage').style.display = 'none';
    
    // Show data visualization page
    document.getElementById('dataHeader').style.display = 'block';
    document.getElementById('mainContainer').style.display = 'grid';

    if (currentData || uploadedFiles.length > 0) {
        setTimeout(() => {
            document.getElementById('floatingChatbox').style.display = 'block';
            document.getElementById('insightsCard').style.display = 'block'; 
        }, 500);
    }
}

let selectedXAxis = '';
let selectedYAxis = '';

function toggleDropdown(axis) {
    const dropdown = document.getElementById(`${axis}Dropdown`);
    const menu = document.getElementById(`${axis}Menu`);
    
    // Close other dropdown
    const otherAxis = axis === 'xAxis' ? 'yAxis' : 'xAxis';
    const otherDropdown = document.getElementById(`${otherAxis}Dropdown`);
    const otherMenu = document.getElementById(`${otherAxis}Menu`);
    otherDropdown.classList.remove('open');
    otherMenu.classList.remove('show');
 
    dropdown.classList.toggle('open');
    menu.classList.toggle('show');
}

function selectColumn(axis, column) {
    if (axis === 'xAxis') {
        selectedXAxis = column;
        document.getElementById('xAxisSelected').textContent = column;
        document.getElementById('xAxisTitle').value = column;

        if (uploadedFiles[currentFileIndex]) {
            uploadedFiles[currentFileIndex].xAxis = column;
            uploadedFiles[currentFileIndex].xAxisTitle = column;
        }

        document.querySelectorAll('#xAxisMenu .claude-dropdown-option').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.textContent === column) {
                opt.classList.add('selected');
            }
        });
    } else {
        selectedYAxis = column;
        document.getElementById('yAxisSelected').textContent = column;
        document.getElementById('yAxisTitle').value = column;

        if (uploadedFiles[currentFileIndex]) {
            uploadedFiles[currentFileIndex].yAxis = column;
            uploadedFiles[currentFileIndex].yAxisTitle = column;
        }
        
        document.querySelectorAll('#yAxisMenu .claude-dropdown-option').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.textContent === column) {
                opt.classList.add('selected');
            }
        });
    }
    document.getElementById(`${axis}Dropdown`).classList.remove('open');
    document.getElementById(`${axis}Menu`).classList.remove('show');
    
    updateChart();
}
// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.model-selector-btn') && !event.target.closest('.model-dropdown')) {
        document.querySelectorAll('.model-dropdown').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
});
function showRegressionEquation(slope, intercept) {
    const equationDiv = document.getElementById('regressionEquation');
    
    // Format the equation as y = mx + b
    const m = slope.toFixed(3);
    const b = intercept.toFixed(3);
    const sign = intercept >= 0 ? '+' : '';
    
    equationDiv.innerHTML = `y = ${m}x ${sign} ${b}`;
    equationDiv.style.display = 'block';
}

function hideRegressionEquation() {
    const equationDiv = document.getElementById('regressionEquation');
    if (equationDiv) {
        equationDiv.style.display = 'none';
    }
}
function showHeroFilePreview(file) {
    const preview = document.getElementById('heroFilePreview');
    const fileName = preview.querySelector('.file-name');
    fileName.textContent = file.name;
    preview.style.display = 'block';
}

function calculateLinearRegression(dataPoints) {
    console.log('Calculating regression for points:', dataPoints);
    
    const n = dataPoints.length;
    if (n < 2) return { slope: 0, intercept: 0, points: [] };
    
    const xMean = dataPoints.reduce((sum, p) => sum + p.x, 0) / n;
    const yMean = dataPoints.reduce((sum, p) => sum + p.y, 0) / n;

    const numerator = dataPoints.reduce((sum, p) => sum + (p.x - xMean) * (p.y - yMean), 0);
    const denominator = dataPoints.reduce((sum, p) => sum + (p.x - xMean) ** 2, 0);
    
    if (denominator === 0) {
        return { 
            slope: 0, 
            intercept: yMean, 
            points: dataPoints.map(p => ({x: p.x, y: yMean})) 
        };
    }
    
    const slope = numerator / denominator;
    const intercept = yMean - slope * xMean;

    // Create line points spanning the full range
    const xMin = Math.min(...dataPoints.map(p => p.x));
    const xMax = Math.max(...dataPoints.map(p => p.x));
    
    const points = [
        { x: xMin, y: slope * xMin + intercept },
        { x: xMax, y: slope * xMax + intercept }
    ];

    console.log('Regression result:', { slope, intercept, points });
    return { slope, intercept, points };
}
function scrollToUpload() {
    const uploadArea = document.getElementById('aiChatboxHero');
    if (uploadArea) {
        uploadArea.scrollIntoView({ behavior: 'smooth' });
    }
}
function addFileToList(data, filename) {
    let displayName = filename;
    let counter = 1;
    
    while (uploadedFiles.some(file => file.name === displayName)) {
        const nameWithoutExt = filename.substring(0, filename.lastIndexOf('.'));
        const extension = filename.substring(filename.lastIndexOf('.'));
        displayName = `${nameWithoutExt} (${counter})${extension}`;
        counter++;
    }
    
    const fileData = {
        name: displayName,
        data: data,
        chartType: 'bar',
        xAxis: '',
        yAxis: '',
        xAxisTitle: '',
        yAxisTitle: ''
    };
    
    uploadedFiles.push(fileData);
    currentFileIndex = uploadedFiles.length - 1;
    
    updateFileList();
    switchToFile(currentFileIndex);
    showDataPage();
}
function updateFileList() {
    const fileList = document.getElementById('fileList');
    
    fileList.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-tile ${index === currentFileIndex ? 'active' : ''}" onclick="switchToFile(${index})">
            <span class="file-tile-name">${file.name}</span>
            <button class="file-delete-btn" onclick="event.stopPropagation(); confirmDeleteFile(${index})" title="Delete file">
                <i class="far fa-trash-alt"></i>
            </button>
        </div>
    `).join('');
}

function switchToFile(index) {
    if (index < 0 || index >= uploadedFiles.length) return;
    
    // Save current file settings before switching
    if (uploadedFiles[currentFileIndex]) {
        uploadedFiles[currentFileIndex].chartType = selectedChartType;
        uploadedFiles[currentFileIndex].xAxis = selectedXAxis;
        uploadedFiles[currentFileIndex].yAxis = selectedYAxis;
        uploadedFiles[currentFileIndex].xAxisTitle = document.getElementById('xAxisTitle').value || '';
        uploadedFiles[currentFileIndex].yAxisTitle = document.getElementById('yAxisTitle').value || '';
    }
    
    currentFileIndex = index;
    const fileData = uploadedFiles[index];
    
    // Update global state from file data
    currentData = fileData.data;
    selectedChartType = fileData.chartType;
    selectedXAxis = fileData.xAxis;
    selectedYAxis = fileData.yAxis;
    
    // Update UI
    updateFileList();
    populateColumnSelectors();
    
    // Update chart type selection
    document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-type="${fileData.chartType}"]`)?.classList.add('active');
    
    // Update axis selections
    document.getElementById('xAxisSelected').textContent = fileData.xAxis || 'Select column...';
    document.getElementById('yAxisSelected').textContent = fileData.yAxis || 'Select column...';
    document.getElementById('xAxisTitle').value = fileData.xAxisTitle || '';
    document.getElementById('yAxisTitle').value = fileData.yAxisTitle || '';
    
    // Clear all column selections first
    document.querySelectorAll('#xAxisMenu .claude-dropdown-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelectorAll('#yAxisMenu .claude-dropdown-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // Only set selections if file has them
    if (fileData.xAxis) {
        document.querySelectorAll('#xAxisMenu .claude-dropdown-option').forEach(opt => {
            if (opt.textContent === fileData.xAxis) {
                opt.classList.add('selected');
            }
        });
    }
    
    if (fileData.yAxis) {
        document.querySelectorAll('#yAxisMenu .claude-dropdown-option').forEach(opt => {
            if (opt.textContent === fileData.yAxis) {
                opt.classList.add('selected');
            }
        });
    }
    
    const regressionToggle = document.getElementById('regressionToggleWrapper');
    if (fileData.chartType === 'regression') {
        regressionToggle.style.display = 'flex';
    } else {
        regressionToggle.style.display = 'none';
    }
    
    document.getElementById('chartTypeSection').style.display = 'block';
    document.getElementById('axisSection').style.display = 'block';
    document.getElementById('insightsCard').style.display = 'block';
    
    updateChart();
}

function confirmDeleteFile(index) {
    const filename = uploadedFiles[index].name;
    
    const modalHTML = `
        <div class="modal-overlay" id="deleteModal">
            <div class="modal">
                <div class="modal-title">Delete File</div>
                <div class="modal-text">Are you sure you want to delete "${filename}"? This action cannot be undone.</div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                    <button class="btn btn-delete" onclick="deleteFile(${index})">Delete</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    if (modal) {
        modal.remove();
    }
}

function deleteFile(index) {
    uploadedFiles.splice(index, 1);
    
    if (uploadedFiles.length === 0) {
        currentData = null;
        selectedXAxis = '';
        selectedYAxis = '';
        currentFileIndex = 0;
        
        document.getElementById('fileList').innerHTML = '';
        
        document.getElementById('chartTypeSection').style.display = 'none';
        document.getElementById('axisSection').style.display = 'none';
        document.getElementById('insightsCard').style.display = 'none';
        
        document.getElementById('xAxisSelected').textContent = 'Select column...';
        document.getElementById('yAxisSelected').textContent = 'Select column...';
        document.getElementById('xAxisTitle').value = '';
        document.getElementById('yAxisTitle').value = '';
        
        showEmptyChart();
        const emptyState = document.querySelector('.empty-state');
        if (emptyState) {
            emptyState.innerHTML = `
                <div class="empty-state-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="empty-state-title">No Data Yet</div>
                <div class="empty-state-text">Upload a data file to get started with your visualization</div>
            `;
        }
    } else {
        if (currentFileIndex >= uploadedFiles.length) {
            currentFileIndex = uploadedFiles.length - 1;
        }
        switchToFile(currentFileIndex);
    }
    
    closeDeleteModal();
    showMessage('File deleted successfully', 'success');
}
function startTypingAnimation() {
    console.log('Starting typing animation...');
    
    const typingText = document.getElementById('typingText');
    const animatedSubtitle = document.querySelector('.animated-subtitle');
    const cursor = document.querySelector('.typing-cursor');
    
    if (!typingText) {
        console.error('typingText element not found');
        return;
    }
    
    // Reset elements
    typingText.textContent = '';
    
    if (animatedSubtitle) {
        animatedSubtitle.classList.remove('show');
    }
    
    if (cursor) {
        cursor.style.display = 'inline-block';
        cursor.style.opacity = '1';
    }
    
    const text = 'ClearViz';
    let index = 0;
    
    function typeText() {
        if (index < text.length) {
            typingText.textContent += text.charAt(index);
            index++;
            setTimeout(typeText, 120);
        } else {
            // Animation complete
            setTimeout(() => {
                if (cursor) {
                    cursor.style.opacity = '0';
                }
                if (animatedSubtitle) {
                    animatedSubtitle.classList.add('show');
                }
            }, 800);
        }
    }
    
    // Start typing immediately
    setTimeout(() => {
        typeText();
    }, 100);
}


let selectedModel = 'llama3';
let heroUploadedFile = null;
document.addEventListener('DOMContentLoaded', function() {
    const heroModelText = document.getElementById('selectedModelText');
    const dataModelText = document.getElementById('selectedDataModelText');
    
    if (heroModelText) {
        heroModelText.textContent = 'Llama 3';
    }
    if (dataModelText) {
        dataModelText.textContent = 'Llama 3';
    }
});
function toggleModelDropdown() {
    const dropdown = document.getElementById('modelDropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
        console.log('Model dropdown toggled');
    }
}

function selectModel(modelName) {
    selectedModel = modelName;
    console.log('Selected model:', modelName);
    
    // Update all model options
    document.querySelectorAll('#modelDropdown .model-option').forEach(option => {
        option.classList.remove('selected');
        const check = option.querySelector('i');
        if (check) {
            check.style.opacity = '0';
        }
    });
    
    // Select the clicked model
    const selectedOption = document.querySelector(`#modelDropdown .model-option[data-model="${modelName}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
        const check = selectedOption.querySelector('i');
        if (check) {
            check.style.opacity = '1';
        }
    }
    
    // Close dropdown
    document.getElementById('modelDropdown').classList.remove('show');
    updateModelButtonText(modelName);
}

function updateModelButtonText(modelName) {
    const modelNames = {
        'llama3': 'Llama 3',
        'llama4-maverick': 'Llama 4 Maverick',
        'llama4-scout': 'Llama 4 Scout'
    };
    
    const buttonText = document.getElementById('selectedModelText');
    if (buttonText) {
        buttonText.textContent = modelNames[modelName] || 'Llama 3';
    }
}

function selectDataModel(modelName) {
    selectedModel = modelName;
    
    // Update data page model options
    document.querySelectorAll('#dataModelDropdown .model-option').forEach(option => {
        option.classList.remove('selected');
        const check = option.querySelector('i');
        if (check) {
            check.style.opacity = '0';
        }
    });
    
    // Select the clicked model
    document.querySelectorAll('#dataModelDropdown .model-option').forEach(option => {
        if (option.dataset.model === modelName) {
            option.classList.add('selected');
            const check = option.querySelector('i');
            if (check) {
                check.style.opacity = '1';
            }
        }
    });
    
    // Close dropdown
    document.getElementById('dataModelDropdown').classList.remove('show');
    updateDataModelButtonText(modelName);
}

function toggleDataModelDropdown() {
    const dropdown = document.getElementById('dataModelDropdown');
    dropdown.classList.toggle('show');
}

function handleHeroFile(event) {
    const file = event.target.files[0];
    if (file) {
        heroUploadedFile = file;
        showHeroFilePreview(file);
    }
}


function removeHeroFile() {
    heroUploadedFile = null;
    document.getElementById('heroFilePreview').style.display = 'none';
    document.getElementById('heroFileInput').value = '';
}

function handleHeroDragOver(e) {
    e.preventDefault();
    document.getElementById('aiChatboxHero').classList.add('dragover');
}

function handleHeroDrop(e) {
    e.preventDefault();
    const chatbox = document.getElementById('aiChatboxHero');
    chatbox.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        heroUploadedFile = file;
        const preview = document.getElementById('heroFilePreview');
        const fileName = preview.querySelector('.file-name');
        fileName.textContent = file.name;
        preview.style.display = 'block';
    }
}

function handleHeroDragLeave(e) {
    document.getElementById('aiChatboxHero').classList.remove('dragover');
}
function updateDataModelButtonText(modelName) {
    const modelNames = {
        'llama3': 'Llama 3',
        'llama4-maverick': 'Llama 4 Maverick',
        'llama4-scout': 'Llama 4 Scout'
    };
    
    const buttonText = document.getElementById('selectedDataModelText');
    if (buttonText) {
        buttonText.textContent = modelNames[modelName] || 'Llama 3';
    }
}
function sendHeroMessage() {
    console.log('Send hero message clicked');
    
    const input = document.getElementById('heroPromptInput');
    const message = input.value.trim();
    
    console.log('Message:', message, 'File:', heroUploadedFile);
    
    // Don't proceed if no message and no file
    if (!message && !heroUploadedFile) {
        console.log('No message or file, returning');
        return;
    }
    
    try {
        // Create new chat
        const chatId = Date.now().toString();
        const newChat = {
            id: chatId,
            title: heroUploadedFile ? heroUploadedFile.name.replace(/\.[^/.]+$/, "") : 'New Chat',
            files: [],
            messages: [],
            createdAt: new Date()
        };
        
        chatHistory.unshift(newChat);
        currentChatId = chatId;
        updateChatList();
        
        console.log('Created new chat:', chatId);
        
        // Process file if uploaded
        if (heroUploadedFile) {
            const fileExtension = heroUploadedFile.name.split('.').pop().toLowerCase();
            const supportedFormats = ['csv', 'xlsx', 'xls', 'json'];
            
            if (supportedFormats.includes(fileExtension)) {
                console.log('Processing supported file');
                processFile(heroUploadedFile);
            } else {
                console.log('Unsupported file, navigating to chat');
                showDataPage();
                setTimeout(() => {
                    startChatWithMessage(message || "I uploaded a file", heroUploadedFile);
                }, 500);
            }
        } else {
            console.log('No file, just message');
            showDataPage();
            setTimeout(() => {
                startChatWithMessage(message, null);
            }, 500);
        }
        
        // Clear inputs
        input.value = '';
        removeHeroFile();
        
    } catch (error) {
        console.error('Error in sendHeroMessage:', error);
        showMessage('Error processing request', 'error');
    }
}

function generateChatTitleFromMessage(message) {
    // Create a title based on the first few words of the message
    const words = message.split(' ').slice(0, 4).join(' ');
    let title = words;
    
    // If message is too short, add some context
    if (words.length < 10) {
        title = `Chat: ${words}`;
    }
    
    // Limit title length
    if (title.length > 30) {
        title = title.substring(0, 27) + '...';
    }
    
    if (currentChatId) {
        const chat = chatHistory.find(c => c.id === currentChatId);
        if (chat) {
            chat.title = title;
            updateChatList();
            
            // Animate typing the title
            const titleDisplay = document.getElementById('chatTitleDisplay');
            if (titleDisplay) {
                titleDisplay.classList.add('typing-title');
                titleDisplay.textContent = '';
                
                let i = 0;
                const typeTitle = () => {
                    if (i < title.length) {
                        titleDisplay.textContent += title.charAt(i);
                        i++;
                        setTimeout(typeTitle, 100);
                    } else {
                        setTimeout(() => {
                            titleDisplay.classList.remove('typing-title');
                        }, 1000);
                    }
                };
                
                typeTitle();
            }
        }
    }
}
function startChatWithMessage(message, file) {
    console.log('Starting chat with message:', message);
    
    // Show floating chatbox and chat area
    document.getElementById('floatingChatbox').style.display = 'block';
    document.getElementById('chatArea').style.display = 'block';
    
    // Add user message to chat
    addToChatLog('user', message);
    
    // Simulate AI typing and response
    setTimeout(() => {
        let response = '';
        
        if (file) {
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const supportedFormats = ['csv', 'xlsx', 'xls', 'json'];
            
            if (supportedFormats.includes(fileExtension)) {
                response = `I can see you've uploaded a ${fileExtension.toUpperCase()} file. Let me help you analyze this data. You can use the visualization tools on the left to create charts, and I'll provide insights about your data.`;
            } else {
                response = `I see you've uploaded a file. For data visualization, please upload your data files using the upload area in the top left panel. I can help analyze CSV, Excel, or JSON files for creating charts and insights.`;
            }
        } else {
            if (message.toLowerCase().includes('data') || message.toLowerCase().includes('chart') || message.toLowerCase().includes('visualization')) {
                response = `I'd be happy to help you with data visualization! Please upload your data file using the upload area on the left, and I can help you create charts and provide insights about your data.`;
            } else if (message.toLowerCase().includes('help')) {
                response = `I'm here to help you visualize and analyze your data! You can upload CSV, Excel, or JSON files, and I'll help you create beautiful charts and discover insights. What would you like to explore?`;
            } else {
                response = `Hello! I'm your data visualization assistant. I can help you analyze data and create charts. To get started, please upload a data file (CSV, Excel, or JSON) using the upload area on the left. What specific analysis are you looking for?`;
            }
        }
        
        addToChatLog('ai', response);
        
        // Save message to chat history
        if (currentChatId) {
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push(
                    { sender: 'user', message: message, timestamp: new Date() },
                    { sender: 'ai', message: response, timestamp: new Date() }
                );
            }
        }
    }, 1500);
}
function sendDataMessage() {
    const input = document.getElementById('dataPromptInput');
    const message = input.value.trim();
    
    if (!message) {
        return; // Don't proceed if no message
    }
    
    // Add to chat
    addToChatLog('user', message);
    
    // Clear input
    input.value = '';
    
    // Simulate AI response
    setTimeout(() => {
        let response = '';
        
        if (currentData && uploadedFiles.length > 0) {
            response = `I can help you analyze your data! Based on your uploaded data, I can provide insights, suggest different chart types, or help you explore specific patterns. What would you like to know about your data?`;
        } else {
            response = `I'd be happy to help! Please upload a data file using the upload area on the left so I can assist you with data analysis and visualization.`;
        }
        
        addToChatLog('ai', response);
        
        // Save messages to chat history
        if (currentChatId) {
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push(
                    { sender: 'user', message: message, timestamp: new Date() },
                    { sender: 'ai', message: response, timestamp: new Date() }
                );
            }
        }
    }, 1000);
}


function startChat(message, file) {
    // Initialize chat log if needed
    if (!document.getElementById('chatLog')) {
        createChatLog();
    }
    
    // Show floating chatbox
    document.getElementById('floatingChatbox').style.display = 'block';
    
    if (message) {
        addToChatLog('user', message);
        
        // Simulate AI response
        setTimeout(() => {
            let response = 'Hello! How can I help you today?';
            if (file) {
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const supportedFormats = ['csv', 'xlsx', 'xls', 'json'];
                
                if (!supportedFormats.includes(fileExtension)) {
                    response = 'I see you\'ve uploaded a file. For data visualization, please upload your data files using the upload area in the top left panel. I can help analyze CSV, Excel, or JSON files for creating charts and insights.';
                }
            }
            addToChatLog('ai', response);
        }, 1000);
    }
}

function createChatLog() {
    const chatLog = document.createElement('div');
    chatLog.id = 'chatLog';
    chatLog.className = 'chat-log';
    
    // Insert after insights card
    const insightsCard = document.getElementById('insightsCard');
    insightsCard.parentNode.insertBefore(chatLog, insightsCard.nextSibling);
}
function addToChatLog(sender, message) {
    let chatLog = document.getElementById('chatLog');
    if (!chatLog) {
        createChatLog();
        chatLog = document.getElementById('chatLog');
    }
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = `chat-bubble ${sender}`;
    
    if (sender === 'ai') {
        bubbleDiv.innerHTML = `
            <div class="ai-bubble-avatar">
                <img src="./assets/iconwhite.png" alt="AI">
            </div>
            <div class="ai-bubble-content">
                <div class="chat-bubble-text">${message}</div>
            </div>
            <button class="bubble-copy-btn" onclick="copyBubbleMessage(this)" title="Copy message">
                <i class="fas fa-copy"></i>
            </button>
        `;
    } else {
        bubbleDiv.innerHTML = `
            <div class="chat-bubble-text">${message}</div>
            <button class="bubble-copy-btn" onclick="copyBubbleMessage(this)" title="Copy message">
                <i class="fas fa-copy"></i>
            </button>
        `;
    }
    
    chatLog.appendChild(bubbleDiv);
    
    // Show chat area
    document.getElementById('chatArea').style.display = 'block';
    
    // Scroll to bottom
    bubbleDiv.scrollIntoView({ behavior: 'smooth' });
}

function copyBubbleMessage(button) {
    const messageText = button.parentNode.querySelector('.chat-bubble-text').textContent;
    navigator.clipboard.writeText(messageText).then(() => {
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy"></i>';
        }, 2000);
    });
}

function copyMessage(button) {
    const messageText = button.parentNode.querySelector('.message-text').textContent;
    navigator.clipboard.writeText(messageText).then(() => {
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy"></i>';
        }, 2000);
    });
}

// Add scroll listener for floating chatbox resizing
window.addEventListener('scroll', () => {
    const chatbox = document.getElementById('floatingChatbox');
    if (chatbox && chatbox.style.display !== 'none') {
        if (window.scrollY > 100) {
            chatbox.classList.add('scrolled');
        } else {
            chatbox.classList.remove('scrolled');
        }
    }
});

       
let chatHistory = [];
let currentChatId = null;
let sidebarOpen = false;

function toggleSidebar() {
    const sidebar = document.getElementById('historySidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const body = document.body;
    
    sidebarOpen = !sidebarOpen;
    
    if (sidebarOpen) {
        sidebar.classList.add('open');
        overlay.classList.add('show');
        body.classList.add('sidebar-open');
    } else {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
        body.classList.remove('sidebar-open');
    }
}

function closeSidebar() {
    const sidebar = document.getElementById('historySidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const body = document.body;
    
    sidebarOpen = false;
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
    body.classList.remove('sidebar-open');
}

function createNewChat() {
    const chatId = Date.now().toString();
    const chatTitle = 'Untitled';
    
    const newChat = {
        id: chatId,
        title: chatTitle,
        files: [],
        messages: [],
        createdAt: new Date()
    };
    
    chatHistory.unshift(newChat);
    currentChatId = chatId;
    
    updateChatList();
    showDataPage();
    closeSidebar();
    
    // Clear current data
    currentData = null;
    uploadedFiles = [];
    
    // Generate auto title
    setTimeout(() => {
        generateChatTitle('New Analysis Session');
    }, 1000);
}

function updateChatList() {
    const chatList = document.getElementById('chatList');
    chatList.innerHTML = '';
    
    chatHistory.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
        chatItem.onclick = () => switchToChat(chat.id);
        
        chatItem.innerHTML = `
            <div class="chat-item-content">
                <div class="chat-item-title" id="title-${chat.id}">${chat.title}</div>
                <div class="chat-item-menu" onclick="event.stopPropagation(); toggleChatMenu('${chat.id}')">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="chat-menu" id="menu-${chat.id}" style="display: none;">
                <div class="chat-menu-option" onclick="event.stopPropagation(); renameChatStart('${chat.id}')">
                    <i class="fas fa-edit"></i> Rename
                </div>
                <div class="chat-menu-option delete" onclick="event.stopPropagation(); confirmDeleteChat('${chat.id}')">
                    <i class="fas fa-trash"></i> Delete
                </div>
            </div>
        `;
        
        chatList.appendChild(chatItem);
    });
}

function switchToChat(chatId) {
    currentChatId = chatId;
    const chat = chatHistory.find(c => c.id === chatId);
    
    if (chat) {
        // Load chat data
        uploadedFiles = chat.files || [];
        currentData = uploadedFiles.length > 0 ? uploadedFiles[0].data : null;
        
        // Update UI
        updateChatList();
        updateFileList();
        
        if (uploadedFiles.length > 0) {
            populateColumnSelectors();
            document.getElementById('chartTypeSection').style.display = 'block';
            document.getElementById('axisSection').style.display = 'block';
            document.getElementById('insightsCard').style.display = 'block';
        }
        
        // Update chat title display
        document.getElementById('chatTitleDisplay').textContent = chat.title;
        
        showDataPage();
        closeSidebar();
    }
}
function toggleChatMenu(chatId) {
    // Close all other menus
    document.querySelectorAll('.chat-menu').forEach(menu => {
        if (menu.id !== `menu-${chatId}`) {
            menu.style.display = 'none';
        }
    });
    
    // Toggle current menu
    const menu = document.getElementById(`menu-${chatId}`);
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function renameChatStart(chatId) {
    // Close menu
    document.getElementById(`menu-${chatId}`).style.display = 'none';
    
    // Make title editable
    const titleElement = document.getElementById(`title-${chatId}`);
    const originalTitle = titleElement.textContent;
    titleElement.contentEditable = true;
    titleElement.classList.add('editing');
    titleElement.focus();
    
    // Select all text
    const range = document.createRange();
    range.selectNodeContents(titleElement);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    // Handle enter key and blur
    const handleFinish = () => {
        titleElement.contentEditable = false;
        titleElement.classList.remove('editing');
        const newTitle = titleElement.textContent.trim() || originalTitle;
        titleElement.textContent = newTitle; // Ensure clean text
        updateChatTitle(chatId, newTitle);
        titleElement.removeEventListener('blur', handleFinish);
        titleElement.removeEventListener('keydown', handleKeyDown);
    };
    
    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent line break
            titleElement.blur(); // This will trigger handleFinish
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            titleElement.textContent = originalTitle; // Restore original
            titleElement.blur();
        }
    };
    
    titleElement.addEventListener('blur', handleFinish);
    titleElement.addEventListener('keydown', handleKeyDown);
}
    
    const handleEnter = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleFinish();
        }
    };
    
    titleElement.addEventListener('blur', handleFinish);
    titleElement.addEventListener('keydown', handleEnter);
}

function confirmDeleteChat(chatId) {
    // Close menu
    document.getElementById(`menu-${chatId}`).style.display = 'none';
    
    const chat = chatHistory.find(c => c.id === chatId);
    const chatTitle = chat ? chat.title : 'this chat';
    
    const modalHTML = `
        <div class="modal-overlay" id="deleteChatModal">
            <div class="modal">
                <div class="modal-title">Delete Chat</div>
                <div class="modal-text">Are you sure you want to delete "${chatTitle}"? This action cannot be undone.</div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeChatDeleteModal()">Cancel</button>
                    <button class="btn btn-delete" onclick="deleteChat('${chatId}')">Delete</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeChatDeleteModal() {
    const modal = document.getElementById('deleteChatModal');
    if (modal) {
        modal.remove();
    }
}

function deleteChat(chatId) {
    const chatIndex = chatHistory.findIndex(c => c.id === chatId);
    if (chatIndex !== -1) {
        chatHistory.splice(chatIndex, 1);
        
        // If deleting current chat, switch to another or go home
        if (chatId === currentChatId) {
            if (chatHistory.length > 0) {
                switchToChat(chatHistory[0].id);
            } else {
                currentChatId = null;
                goHome();
            }
        }
        
        updateChatList();
        showMessage('Chat deleted successfully', 'success');
    }
    
    closeChatDeleteModal();
}

// Close chat menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.chat-item-menu') && !event.target.closest('.chat-menu')) {
        document.querySelectorAll('.chat-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

function updateChatTitle(chatId, newTitle) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (chat) {
        chat.title = newTitle.trim() || 'Untitled';
        updateChatList();
        
        if (chatId === currentChatId) {
            document.getElementById('chatTitleDisplay').textContent = chat.title;
        }
    }
}

function generateChatTitle(filename) {
    const titles = [
        `${filename} Analysis`,
        `Data Insights - ${filename}`,
        `${filename} Visualization`,
        `Exploring ${filename}`,
        `${filename} Dashboard`
    ];
    
    const randomTitle = titles[Math.floor(Math.random() * titles.length)];
    
    if (currentChatId) {
        const chat = chatHistory.find(c => c.id === currentChatId);
        if (chat) {
            chat.title = randomTitle;
            updateChatList();
            
            // Animate typing the title
            const titleDisplay = document.getElementById('chatTitleDisplay');
            titleDisplay.classList.add('typing-title');
            titleDisplay.textContent = '';
            
            let i = 0;
            const typeTitle = () => {
                if (i < randomTitle.length) {
                    titleDisplay.textContent += randomTitle.charAt(i);
                    i++;
                    setTimeout(typeTitle, 100);
                } else {
                    setTimeout(() => {
                        titleDisplay.classList.remove('typing-title');
                    }, 1000);
                }
            };
            
            typeTitle();
        }
    }
}

function generateChartTitle(xColumn, yColumn, chartType) {
    const titles = [
        `${yColumn} by ${xColumn}`,
        `${xColumn} vs ${yColumn} Analysis`,
        `${yColumn} Distribution`,
        `${xColumn} Performance Metrics`,
        `Data Trends: ${yColumn}`
    ];
    
    const randomTitle = titles[Math.floor(Math.random() * titles.length)];
    
    const chartTitleElement = document.getElementById('autoGeneratedChartTitle');
    chartTitleElement.classList.add('typing-title');
    chartTitleElement.textContent = '';
    
    let i = 0;
    const typeTitle = () => {
        if (i < randomTitle.length) {
            chartTitleElement.textContent += randomTitle.charAt(i);
            i++;
            setTimeout(typeTitle, 80);
        } else {
            setTimeout(() => {
                chartTitleElement.classList.remove('typing-title');
            }, 1000);
        }
    };
    
    typeTitle();
}

function enableTitleEdit(element) {
    const originalTitle = element.textContent;
    element.focus();
    
    // Select all text
    const range = document.createRange();
    range.selectNodeContents(element);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    // Handle enter key and blur
    const handleFinish = () => {
        const newTitle = element.textContent.trim() || originalTitle;
        element.textContent = newTitle; // Ensure clean text
        
        if (currentChatId) {
            updateChatTitle(currentChatId, newTitle);
        }
        
        element.removeEventListener('blur', handleFinish);
        element.removeEventListener('keydown', handleKeyDown);
    };
    
    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent line break
            element.blur(); // This will trigger handleFinish
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            element.textContent = originalTitle; // Restore original
            element.blur();
        }
    };
    
    element.addEventListener('blur', handleFinish);
    element.addEventListener('keydown', handleKeyDown);
}

function showHelpPage() {
    console.log('Showing help page');
    
    // Hide all other pages
    document.getElementById('heroSection').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('dataHeader').style.display = 'none';
    
    // Show help page
    document.getElementById('helpPage').style.display = 'block';
    
    // Close sidebar if open
    closeSidebar();
}
function exportChat() {
    if (!currentChatId) {
        showMessage('No active chat to export', 'error');
        return;
    }
    
    const chat = chatHistory.find(c => c.id === currentChatId);
    if (!chat) {
        showMessage('Chat not found', 'error');
        return;
    }
    
    const chatData = {
        title: chat.title,
        createdAt: chat.createdAt,
        messages: chat.messages,
        files: chat.files.map(f => ({ name: f.name, type: f.chartType }))
    };
    
    const dataStr = JSON.stringify(chatData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `${chat.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_chat.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showMessage('Chat exported successfully', 'success');
}
// Add scroll listener for floating chatbox resizing
window.addEventListener('scroll', () => {
    const chatbox = document.getElementById('floatingChatbox');
    if (chatbox && chatbox.style.display !== 'none') {
        if (window.scrollY > 100) {
            chatbox.classList.add('scrolled');
        } else {
            chatbox.classList.remove('scrolled');
        }
    }
});



function openChartInNewWindow() {
    if (!currentChart) {
        showMessage('No chart to display', 'error');
        return;
    }
    
    const canvas = document.getElementById('chart');
    const chartDataURL = canvas.toDataURL('image/png');
    const currentFile = uploadedFiles[currentFileIndex];
    const chartTitle = currentFile ? `${currentFile.name} - ${selectedChartType} Chart` : 'Chart';

    const newWindow = window.open('', '_blank', 'width=800,height=600,resizable=yes');
    
    // Write HTML content without problematic nested scripts
    newWindow.document.write('<!DOCTYPE html>');
    newWindow.document.write('<html><head><title>Chart - ClearViz</title>');
    newWindow.document.write('<style>');
    newWindow.document.write('body { margin: 0; padding: 20px; background: #0a0b0d; color: #f6f8fa; font-family: Inter, sans-serif; display: flex; flex-direction: column; align-items: center; }');
    newWindow.document.write('.header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #374151; }');
    newWindow.document.write('.logo { display: flex; align-items: center; gap: 10px; font-size: 1.25rem; font-weight: 600; }');
    newWindow.document.write('.export-btn { background: linear-gradient(135deg, #58a6ff 0%, #bc8cff 100%); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; }');
    newWindow.document.write('.chart-container { max-width: 100%; max-height: 80vh; }');
    newWindow.document.write('img { max-width: 100%; height: auto; }');
    newWindow.document.write('</style></head><body>');
    newWindow.document.write('<div class="header"><div class="logo"><span>📊 ClearViz Chart</span></div>');
    newWindow.document.write('<button class="export-btn" onclick="window.print()">Print Chart</button></div>');
    newWindow.document.write('<div class="chart-container"><img src="' + chartDataURL + '" alt="Chart"></div>');
    newWindow.document.write('</body></html>');
    newWindow.document.close();
}
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - Initializing everything...');
    
    // Initialize chat history
    chatHistory = [];
    
    // Start typing animation
    setTimeout(() => {
        startTypingAnimation();
    }, 500);
    
    // Initialize all event handlers
    initializeEventHandlers();
    
    // Fix canvas
    fixCanvasSize();
    
    // Show floating chatbox when data is loaded
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                const insightsCard = document.getElementById('insightsCard');
                if (insightsCard && insightsCard.style.display !== 'none') {
                    document.getElementById('floatingChatbox').style.display = 'block';
                }
            }
        });
    });
    
    const insightsCard = document.getElementById('insightsCard');
    if (insightsCard) {
        observer.observe(insightsCard, { 
            attributes: true, 
            attributeFilter: ['style'] 
        });
    }
});

function initializeEventHandlers() {
    console.log('Initializing event handlers...');
    
    // Hero file input handler
    const heroFileInput = document.getElementById('heroFileInput');
    if (heroFileInput) {
        heroFileInput.addEventListener('change', handleHeroFile);
    }
    
    // Hero prompt input enter key handler
    const heroPromptInput = document.getElementById('heroPromptInput');
    if (heroPromptInput) {
        heroPromptInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendHeroMessage();
            }
        });
    }
    
    // Hero send button handler
    const heroSendBtn = document.getElementById('heroSendBtn');
    if (heroSendBtn) {
        heroSendBtn.addEventListener('click', function(e) {
            e.preventDefault();
            sendHeroMessage();
        });
    }
    
    // Help button handler
    const helpButton = document.getElementById('helpButton');
    if (helpButton) {
        helpButton.addEventListener('click', function(e) {
            e.preventDefault();
            showHelpPage();
        });
    }
    
    // Hero model button handler
    const heroModelBtn = document.getElementById('heroModelBtn');
    if (heroModelBtn) {
        heroModelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            toggleModelDropdown();
        });
    }
    
    // File upload button handler
    const fileUploadBtn = document.querySelector('.file-upload-btn');
    if (fileUploadBtn) {
        fileUploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('heroFileInput').click();
        });
    }
    
    // Drag and drop for hero chatbox
    const heroUploadArea = document.getElementById('aiChatboxHero');
    if (heroUploadArea) {
        heroUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            heroUploadArea.classList.add('dragover');
        });

        heroUploadArea.addEventListener('dragleave', function(e) {
            if (!heroUploadArea.contains(e.relatedTarget)) {
                heroUploadArea.classList.remove('dragover');
            }
        });

        heroUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            heroUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                heroUploadedFile = files[0];
                showHeroFilePreview(files[0]);
            }
        });
    }
    
    // Get Started button handler
    const getStartedBtn = document.querySelector('.nav-actions .btn-primary');
    if (getStartedBtn) {
        getStartedBtn.addEventListener('click', function(e) {
            e.preventDefault();
            scrollToUpload();
        });
    }
    
    // Data input handlers
    const dataInput = document.getElementById('dataPromptInput');
    if (dataInput) {
        dataInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendDataMessage();
            }
        });
    }
    
    console.log('Event handlers initialized');
}
        
</script>
</body>
</html>
